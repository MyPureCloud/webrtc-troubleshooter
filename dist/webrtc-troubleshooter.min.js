"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck$2(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck$1(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck$3(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn$1(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits$1(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck$4(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn$2(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits$2(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck$7(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck$6(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck$8(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck$9(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn$4(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits$4(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck$5(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn$3(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits$3(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck$10(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn$5(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits$5(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck$12(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck$11(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn$6(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits$6(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),TestSuite=function(){function e(t){_classCallCheck(this,e),t=t||{},this.allTestsComplete=!1,this.stopOnFailure=!1,this.running=!1,this.queue=[],this.logger=t.logger||console,this.hasError=!1,this.results=[]}return _createClass(e,[{key:"addTest",value:function(e){this.queue.push(e)}},{key:"start",value:function(){var e=this;return new Promise(function(t,r){return e.runNextTest().then(function(){if(e.hasError){var n=new Error("A test failure occurred");return n.details=e.results,r(n)}return t(e.results)},function(t){return t.details=e.results,r(t)})})}},{key:"runNextTest",value:function(){var e=this;this.running=!0;var t=this.queue.shift();if(!t)return this.running=!1,Promise.resolve();this.activeTest=t,this.logger.log("Starting "+t.name);var r=function(r){return t.running=!1,t.destroy(),r&&(e.hasError=!0,e.stopOnFailure)?Promise.reject(r):e.runNextTest()};return t.start().then(function(n){return e.results.push({status:"passed",name:t.name,results:n}),r()},function(n){e.hasError=!0;var o={status:"failed",name:t.name,message:n.message,details:n.details};return e.results.push(o),e.logger.error("Test failure",o,t),r(n)})}},{key:"stopAllTests",value:function(){this.activeTest.destroy(),this.queue=[]}}]),e}(),_createClass$2=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),Test=function(){function e(t){var r=this;_classCallCheck$2(this,e),this.options=t||{},this.logger=this.options.logger||console,this.promise=new Promise(function(e,t){r.deferred={resolve:e,reject:t}})}return _createClass$2(e,[{key:"start",value:function(){var e=this;this.timeout=window.setTimeout(function(){e.reject(new Error("Test Timeout"))},45e3)}},{key:"resolve",value:function(e){return this.deferred.resolve(e),this.promise}},{key:"reject",value:function(e){return this.deferred.reject(e),this.promise}},{key:"destroy",value:function(){window.clearTimeout(this.timeout)}}]),e}(),_createClass$1=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get=function e(t,r,n){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,r);if(void 0===o){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,r,n)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(n)},localMedia=require("localMedia"),MIC_DETECTION_THRESHOLD=-100,AudioTest=function(e){function t(){_classCallCheck$1(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments));return e.name="Audio Test",e.volumeTimeout=e.options.volumeTimeout||5e3,e.localMedia=new localMedia({detectSpeakingEvents:!0}),e}return _inherits(t,e),_createClass$1(t,[{key:"start",value:function(){var e=this;_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",this).call(this);var r=window.setTimeout(function(){e.logger.error("No change in mic volume"),e.reject(new Error("audio timeout"))},this.volumeTimeout);return this.localMedia.start(this.options,function(t){t?(e.logger.error("Audio Local media start failed"),e.reject(t)):e.logger.log("Audio Local media started")}),this.localMedia.on("volumeChange",function(t){t>MIC_DETECTION_THRESHOLD&&(window.clearTimeout(r),e.resolve())}),this.localMedia.on("localStream",function(t){if(t.getAudioTracks().length){var r=t.getAudioTracks()[0];r?e.logger.log("Audio stream passed"):(e.logger.error("Audio stream failed"),e.reject(new Error("no audio tracks available")))}}),this.promise}},{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.localMedia.stop()}}]),t}(Test),_createClass$3=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get$1=function e(t,r,n){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,r);if(void 0===o){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,r,n)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(n)},LocalMedia=require("localMedia"),VideoTest=function(e){function t(){_classCallCheck$3(this,t);var e=_possibleConstructorReturn$1(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments));return e.name="Video Test",e.localMedia=new LocalMedia({detectSpeakingEvents:!0}),e}return _inherits$1(t,e),_createClass$3(t,[{key:"start",value:function(){var e=this;return _get$1(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",this).call(this),this.localMedia.start(this.options,function(t){t?(e.logger.log("Video Local media start failed "+t.name),e.reject(t)):e.logger.log("Video Local media started")}),this.localMedia.on("localStream",function(t){if(t.getVideoTracks().length){var r=t.getVideoTracks()[0];r?(e.logger.log("Video stream passed"),e.resolve()):(e.logger.error("Video stream failed"),e.reject(new Error("no video track available")))}}),this.promise}},{key:"destroy",value:function(){_get$1(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.localMedia.stop()}}]),t}(Test),_createClass$4=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get$2=function e(t,r,n){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,r);if(void 0===o){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,r,n)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(n)},PeerConnection=require("rtcpeerconnection"),ConnectivityTest=function(e){function t(){_classCallCheck$4(this,t);var e=_possibleConstructorReturn$2(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments));return e.name="Connectivity Test",e}return _inherits$2(t,e),_createClass$4(t,[{key:"logIceServers",value:function(){var e=this;this.options.iceServers?(this.options.iceServers.forEach(function(t){e.logger.log("Using ICE Server: "+t.url)}),0===this.options.iceServers.length&&this.logger.error("no ice servers provided")):this.logger.log("Using default ICE Servers")}},{key:"start",value:function(){var e=this;_get$2(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",this).call(this),this.pc1=new PeerConnection(this.options),this.pc2=new PeerConnection(this.options);var r=window.setTimeout(function(){e.logger.error("Connectivity timeout error"),e.reject(new Error("connectivity timeout"))},1e4);this.pc2.on("ice",function(t){e.logger.log("pc2 ICE candidate"),e.pc1.processIce(t)}),this.pc1.on("ice",function(t){e.logger.log("pc1 ICE candidate"),e.pc2.processIce(t)}),this.pc2.on("answer",function(t){e.logger.log("pc2 handle answer"),e.pc1.handleAnswer(t)}),this.pc1.on("offer",function(t){e.logger.log("pc1 offer"),e.pc2.handleOffer(t,function(t){t&&(e.logger.error("pc2 failed to handle offer"),e.reject(t)),e.logger.log("pc2 handle offer"),e.pc2.answer(function(t,r){t&&(e.logger.error("pc2 failed answer"),e.reject(t)),e.logger.log("pc2 successful "+r.type)})})}),this.dataChannel=this.pc1.createDataChannel("testChannel");var n=Array.apply(null,{length:100}).map(function(e,t){return"message "+t}),o=Array.apply(null,{length:100}).map(function(e,t){return"message "+t}),i=0;return this.dataChannel.onmessage=function(t){var o=n.find(function(e){return e===t.data});e.logger.debug("got a message",o),n.splice(n.indexOf(o),1),i++,0===n.length&&(window.clearTimeout(r),e.logger.log("Received "+i+" messages"),e.resolve())},this.pc2.on("addChannel",function(t){t.onopen=function(){e.logger.log("Sending "+n.length+" messages"),o.forEach(t.send.bind(t))}}),this.pc1.offer(),this.promise}},{key:"destroy",value:function(){_get$2(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.pc1.close(),this.pc2.close()}}]),t}(Test),_createClass$7=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),Ssim=function(){function e(){_classCallCheck$7(this,e)}return _createClass$7(e,[{key:"statistics",value:function(e){var t,r=0;for(t=0;t<e.length;++t)r+=e[t];var n=r/(e.length-1),o=0;for(t=1;t<e.length;++t)o=e[t-1]-n,r+=e[t]+o*o;return{mean:n,variance:r/e.length}}},{key:"covariance",value:function(e,t,r,n){for(var o=0,i=0;i<e.length;i+=1)o+=(e[i]-r)*(t[i]-n);return o/e.length}},{key:"calculate",value:function(e,t){if(e.length!==t.length)return 0;var r=.01,n=.03,o=255,i=r*o*(r*o),a=n*o*(n*o),s=a/2,l=this.statistics(e),c=l.mean,u=l.variance,h=Math.sqrt(u),d=this.statistics(t),p=d.mean,f=d.variance,g=Math.sqrt(f),v=this.covariance(e,t,c,p),m=(2*c*p+i)/(c*c+p*p+i),y=(v+s)/(h*g+s),b=(2*h*g+a)/(u+f+a);return m*b*y}}]),e}(),_createClass$6=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),VideoFrameChecker=function(){function e(t){_classCallCheck$6(this,e),this.frameStats={numFrozenFrames:0,numBlackFrames:0,numFrames:0},this.running=!0,this.nonBlackPixelLumaThreshold=20,this.previousFrame=[],this.identicalFrameSsimThreshold=.985,this.frameComparator=new Ssim,this.canvas=document.createElement("canvas"),this.videoElement=t,this.listener=this.checkVideoFrame.bind(this),this.videoElement.addEventListener("play",this.listener,!1)}return _createClass$6(e,[{key:"stop",value:function(){this.videoElement.removeEventListener("play",this.listener),this.running=!1}},{key:"getCurrentImageData",value:function(){this.canvas.width=this.videoElement.width,this.canvas.height=this.videoElement.height;var e=this.canvas.getContext("2d");return e.drawImage(this.videoElement,0,0,this.canvas.width,this.canvas.height),e.getImageData(0,0,this.canvas.width,this.canvas.height)}},{key:"checkVideoFrame",value:function(){if(this.running&&!this.videoElement.ended){var e=this.getCurrentImageData();this.isBlackFrame(e.data,e.data.length)&&this.frameStats.numBlackFrames++,this.frameComparator.calculate(this.previousFrame,e.data)>this.identicalFrameSsimThreshold&&this.frameStats.numFrozenFrames++,this.previousFrame=e.data,this.frameStats.numFrames++,setTimeout(this.checkVideoFrame.bind(this),20)}}},{key:"isBlackFrame",value:function(e,t){for(var r=this.nonBlackPixelLumaThreshold,n=0,o=4;o<t;o+=4)if(n+=.21*e[o]+.72*e[o+1]+.07*e[o+2],n>r*o/4)return!1;return!0}}]),e}(),_createClass$8=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),WebrtcCall=function(){function e(t){_classCallCheck$8(this,e),this.pc1=new RTCPeerConnection(t),this.pc2=new RTCPeerConnection(t),this.pc1.addEventListener("icecandidate",this.onIceCandidate.bind(this,this.pc2)),this.pc2.addEventListener("icecandidate",this.onIceCandidate.bind(this,this.pc1)),this.iceCandidateFilter=e.noFilter}return _createClass$8(e,[{key:"establishConnection",value:function(){var e=this,t=arguments;return this.pc1.createOffer().then(this.gotOffer.bind(this),function(){var r;return(r=e.logger).error.apply(r,t)})}},{key:"close",value:function(){this.pc1.close(),this.pc2.close()}},{key:"gatherStats",value:function(e,t){var r=[],n=[];return new Promise(function(o,i){var a=function i(){return"closed"===e.signalingState?o({stats:r,statsCollectTime:n}):void("undefined"!=typeof mozRTCPeerConnection&&e instanceof mozRTCPeerConnection?setTimeout(i,t):setTimeout(e.getStats.bind(e,s),t))},s=function(e){var t=Date.now(),o=e.result();r=o,n=o.map(function(){return t}),a()};a()})}},{key:"gotOffer",value:function(e){return this.pc1.setLocalDescription(e),this.pc2.setRemoteDescription(e),this.pc2.createAnswer().then(this.gotAnswer.bind(this),console.error.bind(console))}},{key:"gotAnswer",value:function(e){return this.constrainVideoBitrateKbps&&(e.sdp=e.sdp.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+this.constrainVideoBitrateKbps+"\r\n")),this.pc2.setLocalDescription(e),this.pc1.setRemoteDescription(e)}},{key:"onIceCandidate",value:function(e,t){if(t.candidate){var r=this.parseCandidate(t.candidate.candidate);this.iceCandidateFilter(r)&&e.addIceCandidate(t.candidate)}}},{key:"parseCandidate",value:function(e){var t="candidate:",r=e.indexOf(t)+t.length,n=e.substr(r).split(" ");return{type:n[7],protocol:n[2],address:n[4]}}},{key:"setIceCandidateFilter",value:function(e){this.iceCandidateFilter=e}},{key:"disableVideoFec",value:function(){this.constrainOfferToRemoveVideoFec=!0}},{key:"constrainVideoBitrate",value:function(e){this.constrainVideoBitrateKbps=e}}],[{key:"noFilter",value:function(){return!0}},{key:"isRelay",value:function(e){return"relay"===e.type}}]),e}(),_createClass$9=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get$4=function e(t,r,n){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,r);if(void 0===o){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,r,n)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(n)},CameraResolutionTest=function(e){function t(e,r){_classCallCheck$9(this,t);var n=_possibleConstructorReturn$4(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,r));return n.name="Camera resolution test "+JSON.stringify(e),n.resolutions=e,n.duration=r.duration,n.logger=r&&r.logger?r.logger:console,n.log=[],n.currentResolution=0,n.isMuted=!1,n.isShuttingDown=!1,n}return _inherits$4(t,e),_createClass$9(t,[{key:"start",value:function(){var e=this;_get$4(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",this).call(this);var r={resolutions:this.resolutions,duration:this.duration};return this.logger.log("Advanced Camera Test with resolutions: "+JSON.stringify(r.resolutions)+" and duration "+JSON.stringify(r.duration)),this.startGetUserMedia(this.resolutions[this.currentResolution]).then(function(){if(e.hasError){var t=new Error("Camera resolution check failed");return t.details=e.getResults(),e.reject(t)}return e.resolve(e.getResults())},function(t){return t.details=e.getResults(),e.reject(t)})}},{key:"getResults",value:function(){var e={log:this.log,stats:this.stats,resolutions:this.resolutions,duration:this.duration};return e}},{key:"reportSuccess",value:function(e){this.log.push(e),this.logger.log("SUCCESS: "+e)}},{key:"reportError",value:function(e){this.hasError=!0,this.log.push(e),this.logger.warn(""+e)}},{key:"reportInfo",value:function(e){this.logger.info(""+e)}},{key:"startGetUserMedia",value:function(e){var t=this,r={audio:!1,video:{width:{exact:e[0]},height:{exact:e[1]}}};return navigator.mediaDevices.getUserMedia(r).then(function(r){return t.resolutions.length>1?(t.reportSuccess("Supported: "+e[0]+"x"+e[1]),r.getTracks().forEach(function(e){e.stop()}),t.maybeContinueGetUserMedia()):(t.logger.log("collecting"),t.collectAndAnalyzeStats(r,e))},function(r){return t.resolutions.length>1?t.reportInfo(e[0]+"x"+e[1]+" not supported"):t.reportError("getUserMedia failed with error: "+r),t.maybeContinueGetUserMedia()})}},{key:"maybeContinueGetUserMedia",value:function(){var e=this;return this.currentResolution===this.resolutions.length?this.getResults():new Promise(function(t,r){setTimeout(function(){e.startGetUserMedia(e.resolutions[e.currentResolution++]).then(t,r)},1e3)})}},{key:"collectAndAnalyzeStats",value:function(e,t){var r=this,n=e.getVideoTracks();if(n.length<1)return this.reportError("No video track in returned stream."),this.maybeContinueGetUserMedia();var o=n[0];"function"==typeof o.addEventListener&&(o.addEventListener("ended",function(){r.isShuttingDown||r.reportError("Video track ended, camera stopped working")}),o.addEventListener("mute",function(){r.isShuttingDown||(r.reportError("Your camera reported itself as muted."),r.isMuted=!0)}),o.addEventListener("unmute",function(){r.isShuttingDown||(r.reportInfo("Your camera reported itself as unmuted."),r.isMuted=!1)}));var i=document.createElement("video");i.setAttribute("autoplay",""),i.setAttribute("muted",""),i.width=t[0],i.height=t[1],i.srcObject=e;var a=new VideoFrameChecker(i),s=new WebrtcCall;return s.pc1.addStream(e),setTimeout(this.endCall.bind(this,s,e),8e3),s.establishConnection().then(function(){return s.gatherStats(s.pc1,100)},function(e){return Promise.reject(e)}).then(function(n){var o=n.stats,s=n.statsCollectTime,l=r.analyzeStats({resolution:t,videoElement:i,stream:e,frameChecker:a,stats:o,statsCollectTime:s});return a.stop(),l},function(e){return Promise.reject(e)})}},{key:"analyzeStats",value:function(e){var t=e.resolution,r=e.videoElement,n=e.stream,o=e.frameChecker,i=e.stats,a=e.statsCollectTime;this.stats=i;for(var s=[],l=[],c=[],u={},h=o.frameStats,d=0;d<i.length-1;d++)"ssrc"===i[d].type&&i[d].stat("googFrameRateInput")>0&&(s.push(parseInt(i[d].stat("googAvgEncodeMs"),10)),l.push(parseInt(i[d].stat("googFrameRateInput"),10)),c.push(parseInt(i[d].stat("googFrameRateSent"),10)));return u.cameraName=n.getVideoTracks()[0].label||NaN,u.actualVideoWidth=r.videoWidth,u.actualVideoHeight=r.videoHeight,u.mandatoryWidth=t[0],u.mandatoryHeight=t[1],u.encodeSetupTimeMs=this.extractEncoderSetupTime(i,a),u.avgEncodeTimeMs=this.arrayAverage(s),u.minEncodeTimeMs=Math.min.apply(Math,s),u.maxEncodeTimeMs=Math.max.apply(Math,s),u.avgInputFps=this.arrayAverage(l),u.minInputFps=Math.min.apply(Math,l),u.maxInputFps=Math.max.apply(Math,l),u.avgSentFps=this.arrayAverage(c),u.minSentFps=Math.min.apply(Math,c),u.maxSentFps=Math.max.apply(Math,c),u.isMuted=this.isMuted,u.testedFrames=h.numFrames,u.blackFrames=h.numBlackFrames,u.frozenFrames=h.numFrozenFrames,this.testExpectations(u),u}},{key:"endCall",value:function(e,t){this.isShuttingDown=!0,t.getTracks().forEach(function(e){e.stop()}),e.close()}},{key:"extractEncoderSetupTime",value:function(e,t){for(var r=0;r!==e.length;r++)if("ssrc"===e[r].type&&e[r].stat("googFrameRateInput")>0)return JSON.stringify(t[r]-t[0]);return NaN}},{key:"resolutionMatchesIndependentOfRotationOrCrop",value:function(e,t,r,n){var o=Math.min(r,n);return e===r&&t===n||e===n&&t===r||e===o&&n===o}},{key:"testExpectations",value:function(e){var t=[];for(var r in e)"number"==typeof e[r]&&isNaN(e[r])&&t.push(r);0!==t.length&&(e.notAvailableStatus=t,this.reportInfo("Not available: "+t.join(", "))),isNaN(e.avgSentFps)?this.reportInfo("Cannot verify sent FPS."):e.avgSentFps<5?this.reportError("Low average sent FPS: "+e.avgSentFps):this.reportSuccess("Average FPS above threshold"),this.resolutionMatchesIndependentOfRotationOrCrop(e.actualVideoWidth,e.actualVideoHeight,e.mandatoryWidth,e.mandatoryHeight)?this.reportSuccess("Captured video using expected resolution."):this.reportError("Incorrect captured resolution."),0===e.testedFrames?this.reportError("Could not analyze any video frame."):(e.blackFrames>e.testedFrames/3&&this.reportError("Camera delivering lots of black frames."),e.frozenFrames>e.testedFrames/3&&this.reportError("Camera delivering lots of frozen frames."))}},{key:"arrayAverage",value:function(e){for(var t=e.length,r=0,n=0;n<t;n++)r+=e[n];return Math.floor(r/t)}}]),t}(Test),_createClass$5=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get$3=function e(t,r,n){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,r);if(void 0===o){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,r,n)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(n)},AdvancedCameraTest=function(e){function t(e){_classCallCheck$5(this,t);var r=_possibleConstructorReturn$3(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments));return r.name="Advanced Video Test",r.tests=[],r.promise=new Promise(function(e,t){r.deferred={resolve:e,reject:t}}),r.stopOnFailure=!0,r.addTest(new CameraResolutionTest([[320,240]],e)),r.addTest(new CameraResolutionTest([[640,480]],e)),r.addTest(new CameraResolutionTest([[1280,720]],e)),r.addTest(new CameraResolutionTest([[160,120],[320,180],[320,240],[640,360],[640,480],[768,576],[1024,576],[1280,720],[1280,768],[1280,800],[1920,1080],[1920,1200],[3840,2160],[4096,2160]],e)),r}return _inherits$3(t,e),_createClass$5(t,[{key:"start",value:function(){var e=this;return _get$3(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",this).call(this).then(function(t){return e.deferred.resolve(t)},function(t){return e.deferred.reject(t)}),this.promise}},{key:"destroy",value:function(){_get$3(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"stopAllTests",this).call(this)}}]),t}(TestSuite),_createClass$10=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get$5=function e(t,r,n){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,r);if(void 0===o){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,r,n)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(n)},DataChannelThroughputTest=function(e){function t(){_classCallCheck$10(this,t);var e=_possibleConstructorReturn$5(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments));e.name="Data Throughput Test",e.testDurationSeconds=5,e.startTime=null,e.sentPayloadBytes=0,e.receivedPayloadBytes=0,e.stopSending=!1;var r=function(){e.samplePacket="";for(var t=0;1024!==t;++t)e.samplePacket+="h"};return r(),e.maxNumberOfPacketsToSend=1,e.bytesToKeepBuffered=1024*e.maxNumberOfPacketsToSend,e.lastBitrateMeasureTime=null,e.lastReceivedPayloadBytes=0,e.call=null,e.senderChannel=null,e.receiveChannel=null,e}return _inherits$5(t,e),_createClass$10(t,[{key:"start",value:function(){return _get$5(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",this).call(this),this.options.iceServers.length?(this.call=new WebrtcCall(this.options),this.call.setIceCandidateFilter(WebrtcCall.isRelay),this.senderChannel=this.call.pc1.createDataChannel(null),this.senderChannel.addEventListener("open",this.sendingStep.bind(this)),this.call.pc2.addEventListener("datachannel",this.onReceiverChannel.bind(this)),this.call.establishConnection()):(this.logger.error("No ice servers were provided"),this.reject(new Error("No ice servers"))),this.promise}},{key:"onReceiverChannel",value:function(e){this.receiveChannel=e.channel,this.receiveChannel.addEventListener("message",this.onMessageReceived.bind(this))}},{key:"sendingStep",value:function(){var e=new Date;this.startTime||(this.startTime=e,this.lastBitrateMeasureTime=e);for(var t=0;t!==this.maxNumberOfPacketsToSend&&!(this.senderChannel.bufferedAmount>=this.bytesToKeepBuffered);++t)this.sentPayloadBytes+=this.samplePacket.length,this.senderChannel.send(this.samplePacket);e-this.startTime>=1e3*this.testDurationSeconds?this.stopSending=!0:this.throughputTimeout=setTimeout(this.sendingStep.bind(this),1)}},{key:"onMessageReceived",value:function(e){this.receivedPayloadBytes+=e.data.length;var t=new Date;if(t-this.lastBitrateMeasureTime>=1e3){var r=(this.receivedPayloadBytes-this.lastReceivedPayloadBytes)/(t-this.lastBitrateMeasureTime);r=Math.round(1e3*r*8)/1e3,this.logger.log("Transmitting at "+r+" kbps."),this.lastReceivedPayloadBytes=this.receivedPayloadBytes,this.lastBitrateMeasureTime=t}if(this.stopSending&&this.sentPayloadBytes===this.receivedPayloadBytes){this.call.close(),this.call=null;var n=Math.round(10*(t-this.startTime))/1e4,o=8*this.receivedPayloadBytes/1e3;this.logger.log(o+" kb in "+n+" seconds."),this.resolve()}}},{key:"destroy",value:function(){_get$5(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),window.clearTimeout(this.throughputTimeout),this.call&&(this.call.close(),this.call=null)}}]),t}(Test),_createClass$12=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),StatisticsAggregate=function(){function e(t){_classCallCheck$12(this,e),this.startTime=0,this.sum=0,this.count=0,this.max=0,this.rampUpThreshold=t,this.rampUpTime=1/0}return _createClass$12(e,[{key:"add",value:function(e,t){0===this.startTime&&(this.startTime=e),this.sum+=t,this.max=Math.max(this.max,t),this.rampUpTime===1/0&&t>this.rampUpThreshold&&(this.rampUpTime=e),this.count++}},{key:"getAverage",value:function(){return 0===this.count?0:Math.round(this.sum/this.count)}},{key:"getMax",value:function(){return this.max}},{key:"getRampUpTime",value:function(){return this.rampUpTime-this.startTime}}]),e}(),_createClass$11=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get$6=function e(t,r,n){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,r);if(void 0===o){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,r,n)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(n)},VideoBandwidthTest=function(e){function t(){_classCallCheck$11(this,t);var e=_possibleConstructorReturn$6(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments));return e.name="Bandwidth Test",e.maxVideoBitrateKbps=2e3,e.durationMs=4e4,e.statStepMs=100,e.bweStats=new StatisticsAggregate(.75*e.maxVideoBitrateKbps*1e3),e.rttStats=new StatisticsAggregate,e.packetsLost=null,e.videoStats=[],e.startTime=null,e.call=null,e.constraints={audio:!1,video:{width:{min:640,ideal:1280,max:1920},height:{min:480,ideal:720,max:1080}}},e.options.mediaOptions.video.deviceId&&(e.constraints.video.deviceId=e.options.mediaOptions.video.deviceId),
e.providedStream=e.options.screenStream,e.log=[],e.stats={},e}return _inherits$6(t,e),_createClass$11(t,[{key:"start",value:function(){var e=this;if(_get$6(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",this).call(this),!this.options.iceConfig.iceServers.length){var r=new Error("No ice servers were provided");return r.details=this.log,this.reject(r)}this.call=new WebrtcCall(this.options.iceConfig),this.call.setIceCandidateFilter(WebrtcCall.isRelay),this.call.disableVideoFec(),this.call.constrainVideoBitrate(this.maxVideoBitrateKbps);var n=void 0;return n=this.providedStream?this.gotStream(this.providedStream):this.doGetUserMedia(this.constraints),n.then(function(){var t=e.getResults();return e.hasError?(t.error=new Error("Video Bandwidth Error"),e.reject(t)):e.resolve(t)},function(t){var r=e.getResults();return r.error=t,e.reject(t)})}},{key:"getResults",value:function(){return{log:this.log,stats:this.stats,constraints:this.constraints}}},{key:"addLog",value:function(e,t){this.logger[e.toLowerCase()](t),t&&"Object"==typeof t&&(t=JSON.stringify(t)),"error"===e&&(this.hasError=!0),this.log.push(e+": "+t)}},{key:"doGetUserMedia",value:function(e){var t=this;return this.addLog("info",{status:"pending",constraints:e}),navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then(function(e){var r=t.getDeviceName(e.getVideoTracks());return t.addLog("info",{status:"success",camera:r}),t.gotStream(e)},function(e){return t.addLog("error",{status:"fail",error:e}),t.addLog("error","Failed to get access to local media due to error: "+e.name),t.reject(e)})}},{key:"getDeviceName",value:function(e){return 0===e.length?null:e[0].label}},{key:"gotStream",value:function(e){var t=this;return this.call.pc1.addStream(e),this.call.establishConnection().then(function(){return t.addLog("info",{status:"success",message:"establishing connection"}),t.startTime=new Date,t.localStream=e.getVideoTracks()[0],new Promise(function(e,r){t.nextTimeout=setTimeout(function(){t.gatherStats().then(e,r)},t.statStepMs)})},function(e){return t.addLog("warn",{status:"error",error:e}),Promise.reject(e)})}},{key:"gatherStats",value:function(){var e=this,t=new Date;return t-this.startTime>this.durationMs?Promise.resolve(this.completed()):this.call.pc1.getStats(this.localStream).then(this.gotStats.bind(this),function(t){e.addLog("error","Failed to getStats: "+t)})}},{key:"gotStats",value:function(e){var t=this,r="WebkitAppearance"in document.documentElement.style,n=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;if(r){var o="function"==typeof e.result?e.result():e;o.forEach(function(e){if("bweforvideo"===e.id&&e.googAvailableSendBandwidth){var r=parseInt(e.googAvailableSendBandwidth,10);t.bweStats.add(Date.parse(e.timestamp),r)}else if("ssrc"===e.type&&e.googRtt){var n=parseInt(e.googRtt,10);t.rttStats.add(Date.parse(e.timestamp),n),t.videoStats[0]=e.googFrameWidthSent,t.videoStats[1]=e.googFrameHeightSent,t.packetsLost=e.packetsLost,t.packetsSent=e.packetsSent}})}else if(n)for(var i in e){var a=e[i];a.id.startsWith("outbound_rtcp_video_")?(this.rttStats.add(Date.parse(a.timestamp),parseInt(a.mozRtt,10)),this.jitter=a.jitter,this.packetsLost=a.packetsLost):a.id.startsWith("outbound_rtp_video_")&&(this.videoStats[0]="Not supported on Firefox",this.videoStats[1]="Not supported on Firefox",this.bitrateMean=a.bitrateMean,this.bitrateStdDev=a.bitrateStdDev,this.packetsSent=a.packetsSent,this.framerateMean=a.framerateMean)}else this.addLog("error","Only Firefox and Chrome getStats implementations are supported.");return new Promise(function(e,r){t.nextTimeout=setTimeout(function(){t.gatherStats().then(e,r)},t.statStepMs)})}},{key:"completed",value:function(){var e="WebkitAppearance"in document.documentElement.style,t=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;this.call.pc1.getLocalStreams()[0].getTracks().forEach(function(e){e.stop()}),this.call.close(),this.call=null;var r=this.stats;return e?this.videoStats[0]<2&&this.videoStats[1]<2?this.addLog("error","Camera failure: "+this.videoStats[0]+"x"+this.videoStats[1]+". Cannot test bandwidth without a working camera."):(r.resolution=this.videoStats[0]+"x"+this.videoStats[1],r.mbpsAvg=this.bweStats.getAverage()/1e6,r.mbpsMax=this.bweStats.getMax()/1e6,r.rampUpTimeMs=this.bweStats.getRampUpTime(),this.addLog("info","Video resolution: "+r.resolution),this.addLog("info","Send bandwidth estimate average: "+r.mbpsAvg+" mpbs"),this.addLog("info","Send bandwidth estimate max: "+r.mbpsMax+" mbps"),this.addLog("info","Send bandwidth ramp-up time: "+r.rampUpTimeMs+" ms")):t&&(parseInt(this.framerateMean,10)>0?this.addLog("info","Frame rate mean: "+parseInt(this.framerateMean,10)):this.addLog("error","Frame rate mean is 0, cannot test bandwidth without a working camera."),r.framerateMean=this.framerateMean||null,r.mbpsAvg=this.bitrateMean/1e6,r.mbpsStdDev=this.bitrateStdDev/1e6,this.addLog("info","Send bitrate mean: "+r.mbpsAvg+" mbps"),this.addLog("info","Send bitrate standard deviation: "+r.mbpsStdDev+" mbps")),r.rttAverage=this.rttStats.getAverage(),r.rttMax=this.rttStats.getMax(),this.packetsSent&&(r.packetLoss=parseInt(this.packetsLost,10)/parseFloat(this.packetsSent)),this.addLog("info","RTT average: "+r.rttAverage+" ms"),this.addLog("info","RTT max: "+r.rttMax+" ms"),this.addLog("info","Lost packets: "+r.lostPackets),this.results}},{key:"destroy",value:function(){_get$6(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),window.clearTimeout(this.nextTimeout),this.call&&(this.call.close(),this.call=null)}}]),t}(Test),index={TestSuite:TestSuite,AudioTest:AudioTest,VideoTest:VideoTest,ConnectivityTest:ConnectivityTest,AdvancedCameraTest:AdvancedCameraTest,ThroughputTest:DataChannelThroughputTest,VideoBandwidthTest:VideoBandwidthTest,VideoFrameChecker:VideoFrameChecker};module.exports=index;
