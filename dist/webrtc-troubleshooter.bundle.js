(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.WebRTCTroubleshooter=f()}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||n<0||isNaN(n))throw TypeError("n must be a positive number");this._maxListeners=n;return this};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)this._events={};if(type==="error"){if(!this._events.error||isObject(this._events.error)&&!this._events.error.length){er=arguments[1];if(er instanceof Error){throw er}else{var err=new Error('Uncaught, unspecified "error" event. ('+er+")");err.context=er;throw err}}}handler=this._events[type];if(isUndefined(handler))return false;if(isFunction(handler)){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:args=Array.prototype.slice.call(arguments,1);handler.apply(this,args)}}else if(isObject(handler)){args=Array.prototype.slice.call(arguments,1);listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++)listeners[i].apply(this,args)}return true};EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events)this._events={};if(this._events.newListener)this.emit("newListener",type,isFunction(listener.listener)?listener.listener:listener);if(!this._events[type])this._events[type]=listener;else if(isObject(this._events[type]))this._events[type].push(listener);else this._events[type]=[this._events[type],listener];if(isObject(this._events[type])&&!this._events[type].warned){if(!isUndefined(this._maxListeners)){m=this._maxListeners}else{m=EventEmitter.defaultMaxListeners}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error("(node) warning: possible EventEmitter memory "+"leak detected. %d listeners added. "+"Use emitter.setMaxListeners() to increase limit.",this._events[type].length);if(typeof console.trace==="function"){console.trace()}}}return this};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!isFunction(listener))throw TypeError("listener must be a function");var fired=false;function g(){this.removeListener(type,g);if(!fired){fired=true;listener.apply(this,arguments)}}g.listener=listener;this.on(type,g);return this};EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;list=this._events[type];length=list.length;position=-1;if(list===listener||isFunction(list.listener)&&list.listener===listener){delete this._events[type];if(this._events.removeListener)this.emit("removeListener",type,listener)}else if(isObject(list)){for(i=length;i-- >0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}}if(position<0)return this;if(list.length===1){list.length=0;delete this._events[type]}else{list.splice(position,1)}if(this._events.removeListener)this.emit("removeListener",type,listener)}return this};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener){if(arguments.length===0)this._events={};else if(this._events[type])delete this._events[type];return this}if(arguments.length===0){for(key in this._events){if(key==="removeListener")continue;this.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events={};return this}listeners=this._events[type];if(isFunction(listeners)){this.removeListener(type,listeners)}else if(listeners){while(listeners.length)this.removeListener(type,listeners[listeners.length-1])}delete this._events[type];return this};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])ret=[];else if(isFunction(this._events[type]))ret=[this._events[type]];else ret=this._events[type].slice();return ret};EventEmitter.prototype.listenerCount=function(type){if(this._events){var evlistener=this._events[type];if(isFunction(evlistener))return 1;else if(evlistener)return evlistener.length}return 0};EventEmitter.listenerCount=function(emitter,type){return emitter.listenerCount(type)};function isFunction(arg){return typeof arg==="function"}function isNumber(arg){return typeof arg==="number"}function isObject(arg){return typeof arg==="object"&&arg!==null}function isUndefined(arg){return arg===void 0}},{}],2:[function(require,module,exports){var cache={};module.exports=function(constraints,cb){var hasConstraints=arguments.length===2;var callback=hasConstraints?cb:constraints;var error;if(typeof window==="undefined"||window.location.protocol==="http:"){error=new Error("NavigatorUserMediaError");error.name="HTTPS_REQUIRED";return callback(error)}if(window.navigator.userAgent.match("Chrome")){var chromever=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10);var maxver=33;var isCef=!window.chrome.webstore;if(window.navigator.userAgent.match("Linux"))maxver=35;if(sessionStorage.getScreenMediaJSExtensionId){chrome.runtime.sendMessage(sessionStorage.getScreenMediaJSExtensionId,{type:"getScreen",id:1},null,function(data){if(!data||data.sourceId===""){var error=new Error("NavigatorUserMediaError");error.name="NotAllowedError";callback(error)}else{constraints=hasConstraints&&constraints||{audio:false,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,maxFrameRate:3}}};constraints.video.mandatory.chromeMediaSourceId=data.sourceId;window.navigator.mediaDevices.getUserMedia(constraints).then(function(stream){callback(null,stream)}).catch(function(err){callback(err)})}})}else if(window.cefGetScreenMedia){window.cefGetScreenMedia(function(sourceId){if(!sourceId){var error=new Error("cefGetScreenMediaError");error.name="CEF_GETSCREENMEDIA_CANCELED";callback(error)}else{constraints=hasConstraints&&constraints||{audio:false,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,maxFrameRate:3},optional:[{googLeakyBucket:true},{googTemporalLayeredScreencast:true}]}};constraints.video.mandatory.chromeMediaSourceId=sourceId;window.navigator.mediaDevices.getUserMedia(constraints).then(function(stream){callback(null,stream)}).catch(function(err){callback(err)})}})}else if(isCef||chromever>=26&&chromever<=maxver){constraints=hasConstraints&&constraints||{video:{mandatory:{googLeakyBucket:true,maxWidth:window.screen.width,maxHeight:window.screen.height,maxFrameRate:3,chromeMediaSource:"screen"}}};window.navigator.mediaDevices.getUserMedia(constraints).then(function(stream){callback(null,stream)}).catch(function(err){callback(err)})}else{var pending=window.setTimeout(function(){error=new Error("NavigatorUserMediaError");error.name="EXTENSION_UNAVAILABLE";return callback(error)},1e3);cache[pending]=[callback,hasConstraints?constraints:null];window.postMessage({type:"getScreen",id:pending},"*")}}else if(window.navigator.userAgent.match("Firefox")){var ffver=parseInt(window.navigator.userAgent.match(/Firefox\/(.*)/)[1],10);if(ffver>=33){constraints=hasConstraints&&constraints||{video:{mozMediaSource:"window",mediaSource:"window"}};window.navigator.mediaDevices.getUserMedia(constraints).then(function(stream){callback(null,stream);var lastTime=stream.currentTime;var polly=window.setInterval(function(){if(!stream)window.clearInterval(polly);if(stream.currentTime==lastTime){window.clearInterval(polly);if(stream.onended){stream.onended()}}lastTime=stream.currentTime},500)}).catch(function(err){callback(err)})}else{error=new Error("NavigatorUserMediaError");error.name="EXTENSION_UNAVAILABLE"}}};typeof window!=="undefined"&&window.addEventListener("message",function(event){if(event.origin!=window.location.origin){return}if(event.data.type=="gotScreen"&&cache[event.data.id]){var data=cache[event.data.id];var constraints=data[1];var callback=data[0];delete cache[event.data.id];if(event.data.sourceId===""){var error=new Error("NavigatorUserMediaError");error.name="NotAllowedError";callback(error)}else{constraints=constraints||{audio:false,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,maxFrameRate:3},optional:[{googLeakyBucket:true},{googTemporalLayeredScreencast:true}]}};constraints.video.mandatory.chromeMediaSourceId=event.data.sourceId;window.navigator.mediaDevices.getUserMedia(constraints).then(function(stream){callback(null,stream)}).catch(function(err){callback(err)})}}else if(event.data.type=="getScreenPending"){window.clearTimeout(event.data.id)}})},{}],3:[function(require,module,exports){var WildEmitter=require("wildemitter");function getMaxVolume(analyser,fftBins){var maxVolume=-Infinity;analyser.getFloatFrequencyData(fftBins);for(var i=4,ii=fftBins.length;i<ii;i++){if(fftBins[i]>maxVolume&&fftBins[i]<0){maxVolume=fftBins[i]}}return maxVolume}var audioContextType;if(typeof window!=="undefined"){audioContextType=window.AudioContext||window.webkitAudioContext}var audioContext=null;module.exports=function(stream,options){var harker=new WildEmitter;if(!audioContextType)return harker;var options=options||{},smoothing=options.smoothing||.1,interval=options.interval||50,threshold=options.threshold,play=options.play,history=options.history||10,running=true;if(!audioContext){audioContext=new audioContextType}var sourceNode,fftBins,analyser;analyser=audioContext.createAnalyser();analyser.fftSize=512;analyser.smoothingTimeConstant=smoothing;fftBins=new Float32Array(analyser.frequencyBinCount);if(stream.jquery)stream=stream[0];if(stream instanceof HTMLAudioElement||stream instanceof HTMLVideoElement){sourceNode=audioContext.createMediaElementSource(stream);if(typeof play==="undefined")play=true;threshold=threshold||-50}else{sourceNode=audioContext.createMediaStreamSource(stream);threshold=threshold||-50}sourceNode.connect(analyser);if(play)analyser.connect(audioContext.destination);harker.speaking=false;harker.setThreshold=function(t){threshold=t};harker.setInterval=function(i){interval=i};harker.stop=function(){running=false;harker.emit("volume_change",-100,threshold);if(harker.speaking){harker.speaking=false;harker.emit("stopped_speaking")}analyser.disconnect();sourceNode.disconnect()};harker.speakingHistory=[];for(var i=0;i<history;i++){harker.speakingHistory.push(0)}var looper=function(){setTimeout(function(){if(!running){return}var currentVolume=getMaxVolume(analyser,fftBins);harker.emit("volume_change",currentVolume,threshold);var history=0;if(currentVolume>threshold&&!harker.speaking){for(var i=harker.speakingHistory.length-3;i<harker.speakingHistory.length;i++){history+=harker.speakingHistory[i]}if(history>=2){harker.speaking=true;harker.emit("speaking")}}else if(currentVolume<threshold&&harker.speaking){for(var i=0;i<harker.speakingHistory.length;i++){history+=harker.speakingHistory[i]}if(history==0){harker.speaking=false;harker.emit("stopped_speaking")}}harker.speakingHistory.shift();harker.speakingHistory.push(0+(currentVolume>threshold));looper()},interval)};looper();return harker}},{wildemitter:18}],4:[function(require,module,exports){var util=require("util");var hark=require("hark");var getScreenMedia=require("getscreenmedia");var WildEmitter=require("wildemitter");var mockconsole=require("mockconsole");function isAllTracksEnded(stream){var isAllTracksEnded=true;stream.getTracks().forEach(function(t){isAllTracksEnded=t.readyState==="ended"&&isAllTracksEnded});return isAllTracksEnded}function shouldWorkAroundFirefoxStopStream(){if(typeof window==="undefined"){return false}if(!window.navigator.mozGetUserMedia){return false}var match=window.navigator.userAgent.match(/Firefox\/(\d+)\./);var version=match&&match.length>=1&&parseInt(match[1],10);return version<50}function LocalMedia(opts){WildEmitter.call(this);var config=this.config={detectSpeakingEvents:false,audioFallback:false,media:{audio:true,video:true},harkOptions:null,logger:mockconsole};var item;for(item in opts){if(opts.hasOwnProperty(item)){this.config[item]=opts[item]}}this.logger=config.logger;this._log=this.logger.log.bind(this.logger,"LocalMedia:");this._logerror=this.logger.error.bind(this.logger,"LocalMedia:");this.localStreams=[];this.localScreens=[];if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){this._logerror("Your browser does not support local media capture.")}this._audioMonitors=[];this.on("localStreamStopped",this._stopAudioMonitor.bind(this));this.on("localScreenStopped",this._stopAudioMonitor.bind(this))}util.inherits(LocalMedia,WildEmitter);LocalMedia.prototype.start=function(mediaConstraints,cb){var self=this;var constraints=mediaConstraints||this.config.media;this.emit("localStreamRequested",constraints);navigator.mediaDevices.getUserMedia(constraints).then(function(stream){if(constraints.audio&&self.config.detectSpeakingEvents){self._setupAudioMonitor(stream,self.config.harkOptions)}self.localStreams.push(stream);stream.getTracks().forEach(function(track){track.addEventListener("ended",function(){if(isAllTracksEnded(stream)){self._removeStream(stream)}})});self.emit("localStream",stream);if(cb){return cb(null,stream)}}).catch(function(err){if(self.config.audioFallback&&err.name==="DevicesNotFoundError"&&constraints.video!==false){constraints.video=false;self.start(constraints,cb);return}self.emit("localStreamRequestFailed",constraints);if(cb){return cb(err,null)}})};LocalMedia.prototype.stop=function(stream){this.stopStream(stream);this.stopScreenShare(stream)};LocalMedia.prototype.stopStream=function(stream){var self=this;if(stream){var idx=this.localStreams.indexOf(stream);if(idx>-1){stream.getTracks().forEach(function(track){track.stop()});if(shouldWorkAroundFirefoxStopStream()){this._removeStream(stream)}}}else{this.localStreams.forEach(function(stream){stream.getTracks().forEach(function(track){track.stop()});if(shouldWorkAroundFirefoxStopStream()){self._removeStream(stream)}})}};LocalMedia.prototype.startScreenShare=function(constraints,cb){var self=this;this.emit("localScreenRequested");if(typeof constraints==="function"&&!cb){cb=constraints;constraints=null}getScreenMedia(constraints,function(err,stream){if(!err){self.localScreens.push(stream);stream.getTracks().forEach(function(track){track.addEventListener("ended",function(){var isAllTracksEnded=true;stream.getTracks().forEach(function(t){isAllTracksEnded=t.readyState==="ended"&&isAllTracksEnded});if(isAllTracksEnded){self._removeStream(stream)}})});self.emit("localScreen",stream)}else{self.emit("localScreenRequestFailed")}if(cb){return cb(err,stream)}})};LocalMedia.prototype.stopScreenShare=function(stream){var self=this;if(stream){var idx=this.localScreens.indexOf(stream);if(idx>-1){stream.getTracks().forEach(function(track){track.stop()});if(shouldWorkAroundFirefoxStopStream()){this._removeStream(stream)}}}else{this.localScreens.forEach(function(stream){stream.getTracks().forEach(function(track){track.stop()});if(shouldWorkAroundFirefoxStopStream()){self._removeStream(stream)}})}};LocalMedia.prototype.mute=function(){this._audioEnabled(false);this.emit("audioOff")};LocalMedia.prototype.unmute=function(){this._audioEnabled(true);this.emit("audioOn")};LocalMedia.prototype.pauseVideo=function(){this._videoEnabled(false);this.emit("videoOff")};LocalMedia.prototype.resumeVideo=function(){this._videoEnabled(true);this.emit("videoOn")};LocalMedia.prototype.pause=function(){this.mute();this.pauseVideo()};LocalMedia.prototype.resume=function(){this.unmute();this.resumeVideo()};LocalMedia.prototype._audioEnabled=function(bool){this.localStreams.forEach(function(stream){stream.getAudioTracks().forEach(function(track){track.enabled=!!bool})})};LocalMedia.prototype._videoEnabled=function(bool){this.localStreams.forEach(function(stream){stream.getVideoTracks().forEach(function(track){track.enabled=!!bool})})};LocalMedia.prototype.isAudioEnabled=function(){var enabled=true;this.localStreams.forEach(function(stream){stream.getAudioTracks().forEach(function(track){enabled=enabled&&track.enabled})});return enabled};LocalMedia.prototype.isVideoEnabled=function(){var enabled=true;this.localStreams.forEach(function(stream){stream.getVideoTracks().forEach(function(track){enabled=enabled&&track.enabled})});return enabled};LocalMedia.prototype._removeStream=function(stream){var idx=this.localStreams.indexOf(stream);if(idx>-1){this.localStreams.splice(idx,1);this.emit("localStreamStopped",stream)}else{idx=this.localScreens.indexOf(stream);if(idx>-1){this.localScreens.splice(idx,1);this.emit("localScreenStopped",stream)}}};LocalMedia.prototype._setupAudioMonitor=function(stream,harkOptions){this._log("Setup audio");var audio=hark(stream,harkOptions);var self=this;var timeout;audio.on("speaking",function(){self.emit("speaking")});audio.on("stopped_speaking",function(){if(timeout){clearTimeout(timeout)}timeout=setTimeout(function(){self.emit("stoppedSpeaking")},1e3)});audio.on("volume_change",function(volume,threshold){self.emit("volumeChange",volume,threshold)});this._audioMonitors.push({audio:audio,stream:stream})};LocalMedia.prototype._stopAudioMonitor=function(stream){var idx=-1;this._audioMonitors.forEach(function(monitors,i){if(monitors.stream===stream){idx=i}});if(idx>-1){this._audioMonitors[idx].audio.stop();this._audioMonitors.splice(idx,1)}};module.exports=LocalMedia},{getscreenmedia:2,hark:3,mockconsole:6,util:16,wildemitter:18}],5:[function(require,module,exports){(function(global){var LARGE_ARRAY_SIZE=200;var HASH_UNDEFINED="__lodash_hash_undefined__";var MAX_SAFE_INTEGER=9007199254740991;var argsTag="[object Arguments]",arrayTag="[object Array]",boolTag="[object Boolean]",dateTag="[object Date]",errorTag="[object Error]",funcTag="[object Function]",genTag="[object GeneratorFunction]",mapTag="[object Map]",numberTag="[object Number]",objectTag="[object Object]",promiseTag="[object Promise]",regexpTag="[object RegExp]",setTag="[object Set]",stringTag="[object String]",symbolTag="[object Symbol]",weakMapTag="[object WeakMap]";var arrayBufferTag="[object ArrayBuffer]",dataViewTag="[object DataView]",float32Tag="[object Float32Array]",float64Tag="[object Float64Array]",int8Tag="[object Int8Array]",int16Tag="[object Int16Array]",int32Tag="[object Int32Array]",uint8Tag="[object Uint8Array]",uint8ClampedTag="[object Uint8ClampedArray]",uint16Tag="[object Uint16Array]",uint32Tag="[object Uint32Array]";var reRegExpChar=/[\\^$.*+?()[\]{}|]/g;var reFlags=/\w*$/;var reIsHostCtor=/^\[object .+?Constructor\]$/;var reIsUint=/^(?:0|[1-9]\d*)$/;var cloneableTags={};cloneableTags[argsTag]=cloneableTags[arrayTag]=cloneableTags[arrayBufferTag]=cloneableTags[dataViewTag]=cloneableTags[boolTag]=cloneableTags[dateTag]=cloneableTags[float32Tag]=cloneableTags[float64Tag]=cloneableTags[int8Tag]=cloneableTags[int16Tag]=cloneableTags[int32Tag]=cloneableTags[mapTag]=cloneableTags[numberTag]=cloneableTags[objectTag]=cloneableTags[regexpTag]=cloneableTags[setTag]=cloneableTags[stringTag]=cloneableTags[symbolTag]=cloneableTags[uint8Tag]=cloneableTags[uint8ClampedTag]=cloneableTags[uint16Tag]=cloneableTags[uint32Tag]=true;cloneableTags[errorTag]=cloneableTags[funcTag]=cloneableTags[weakMapTag]=false;var freeGlobal=typeof global=="object"&&global&&global.Object===Object&&global;var freeSelf=typeof self=="object"&&self&&self.Object===Object&&self;var root=freeGlobal||freeSelf||Function("return this")();var freeExports=typeof exports=="object"&&exports&&!exports.nodeType&&exports;var freeModule=freeExports&&typeof module=="object"&&module&&!module.nodeType&&module;var moduleExports=freeModule&&freeModule.exports===freeExports;function addMapEntry(map,pair){map.set(pair[0],pair[1]);return map}function addSetEntry(set,value){set.add(value);return set}function arrayEach(array,iteratee){var index=-1,length=array?array.length:0;while(++index<length){if(iteratee(array[index],index,array)===false){break}}return array}function arrayPush(array,values){var index=-1,length=values.length,offset=array.length;while(++index<length){array[offset+index]=values[index]}return array}function arrayReduce(array,iteratee,accumulator,initAccum){var index=-1,length=array?array.length:0;if(initAccum&&length){accumulator=array[++index]}while(++index<length){accumulator=iteratee(accumulator,array[index],index,array)}return accumulator}function baseTimes(n,iteratee){var index=-1,result=Array(n);while(++index<n){result[index]=iteratee(index)}return result}function getValue(object,key){return object==null?undefined:object[key]}function isHostObject(value){var result=false;if(value!=null&&typeof value.toString!="function"){try{result=!!(value+"")}catch(e){}}return result}function mapToArray(map){var index=-1,result=Array(map.size);map.forEach(function(value,key){result[++index]=[key,value]});return result}function overArg(func,transform){return function(arg){return func(transform(arg))}}function setToArray(set){var index=-1,result=Array(set.size);set.forEach(function(value){result[++index]=value});return result}var arrayProto=Array.prototype,funcProto=Function.prototype,objectProto=Object.prototype;var coreJsData=root["__core-js_shared__"];var maskSrcKey=function(){var uid=/[^.]+$/.exec(coreJsData&&coreJsData.keys&&coreJsData.keys.IE_PROTO||"");return uid?"Symbol(src)_1."+uid:""}();var funcToString=funcProto.toString;var hasOwnProperty=objectProto.hasOwnProperty;var objectToString=objectProto.toString;var reIsNative=RegExp("^"+funcToString.call(hasOwnProperty).replace(reRegExpChar,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");var Buffer=moduleExports?root.Buffer:undefined,Symbol=root.Symbol,Uint8Array=root.Uint8Array,getPrototype=overArg(Object.getPrototypeOf,Object),objectCreate=Object.create,propertyIsEnumerable=objectProto.propertyIsEnumerable,splice=arrayProto.splice;var nativeGetSymbols=Object.getOwnPropertySymbols,nativeIsBuffer=Buffer?Buffer.isBuffer:undefined,nativeKeys=overArg(Object.keys,Object);var DataView=getNative(root,"DataView"),Map=getNative(root,"Map"),Promise=getNative(root,"Promise"),Set=getNative(root,"Set"),WeakMap=getNative(root,"WeakMap"),nativeCreate=getNative(Object,"create");var dataViewCtorString=toSource(DataView),mapCtorString=toSource(Map),promiseCtorString=toSource(Promise),setCtorString=toSource(Set),weakMapCtorString=toSource(WeakMap);var symbolProto=Symbol?Symbol.prototype:undefined,symbolValueOf=symbolProto?symbolProto.valueOf:undefined;function Hash(entries){var index=-1,length=entries?entries.length:0;this.clear();while(++index<length){var entry=entries[index];this.set(entry[0],entry[1])}}function hashClear(){this.__data__=nativeCreate?nativeCreate(null):{}}function hashDelete(key){return this.has(key)&&delete this.__data__[key]}function hashGet(key){var data=this.__data__;if(nativeCreate){var result=data[key];return result===HASH_UNDEFINED?undefined:result}return hasOwnProperty.call(data,key)?data[key]:undefined}function hashHas(key){var data=this.__data__;return nativeCreate?data[key]!==undefined:hasOwnProperty.call(data,key)}function hashSet(key,value){var data=this.__data__;data[key]=nativeCreate&&value===undefined?HASH_UNDEFINED:value;return this}Hash.prototype.clear=hashClear;Hash.prototype["delete"]=hashDelete;Hash.prototype.get=hashGet;Hash.prototype.has=hashHas;Hash.prototype.set=hashSet;function ListCache(entries){var index=-1,length=entries?entries.length:0;this.clear();while(++index<length){var entry=entries[index];this.set(entry[0],entry[1])}}function listCacheClear(){this.__data__=[]}function listCacheDelete(key){var data=this.__data__,index=assocIndexOf(data,key);if(index<0){return false}var lastIndex=data.length-1;if(index==lastIndex){data.pop()}else{splice.call(data,index,1)}return true}function listCacheGet(key){var data=this.__data__,index=assocIndexOf(data,key);return index<0?undefined:data[index][1]}function listCacheHas(key){return assocIndexOf(this.__data__,key)>-1}function listCacheSet(key,value){var data=this.__data__,index=assocIndexOf(data,key);if(index<0){data.push([key,value])}else{data[index][1]=value}return this}ListCache.prototype.clear=listCacheClear;ListCache.prototype["delete"]=listCacheDelete;ListCache.prototype.get=listCacheGet;ListCache.prototype.has=listCacheHas;ListCache.prototype.set=listCacheSet;function MapCache(entries){var index=-1,length=entries?entries.length:0;this.clear();while(++index<length){var entry=entries[index];this.set(entry[0],entry[1])}}function mapCacheClear(){this.__data__={hash:new Hash,map:new(Map||ListCache),string:new Hash}}function mapCacheDelete(key){return getMapData(this,key)["delete"](key)}function mapCacheGet(key){return getMapData(this,key).get(key)}function mapCacheHas(key){return getMapData(this,key).has(key)}function mapCacheSet(key,value){getMapData(this,key).set(key,value);return this}MapCache.prototype.clear=mapCacheClear;MapCache.prototype["delete"]=mapCacheDelete;MapCache.prototype.get=mapCacheGet;MapCache.prototype.has=mapCacheHas;MapCache.prototype.set=mapCacheSet;function Stack(entries){this.__data__=new ListCache(entries)}function stackClear(){this.__data__=new ListCache}function stackDelete(key){return this.__data__["delete"](key)}function stackGet(key){return this.__data__.get(key)}function stackHas(key){return this.__data__.has(key)}function stackSet(key,value){var cache=this.__data__;if(cache instanceof ListCache){var pairs=cache.__data__;if(!Map||pairs.length<LARGE_ARRAY_SIZE-1){pairs.push([key,value]);return this}cache=this.__data__=new MapCache(pairs)}cache.set(key,value);return this}Stack.prototype.clear=stackClear;Stack.prototype["delete"]=stackDelete;Stack.prototype.get=stackGet;Stack.prototype.has=stackHas;Stack.prototype.set=stackSet;function arrayLikeKeys(value,inherited){var result=isArray(value)||isArguments(value)?baseTimes(value.length,String):[];var length=result.length,skipIndexes=!!length;for(var key in value){if((inherited||hasOwnProperty.call(value,key))&&!(skipIndexes&&(key=="length"||isIndex(key,length)))){result.push(key)}}return result}function assignValue(object,key,value){var objValue=object[key];if(!(hasOwnProperty.call(object,key)&&eq(objValue,value))||value===undefined&&!(key in object)){object[key]=value}}function assocIndexOf(array,key){var length=array.length;while(length--){if(eq(array[length][0],key)){return length}}return-1}function baseAssign(object,source){return object&&copyObject(source,keys(source),object)}function baseClone(value,isDeep,isFull,customizer,key,object,stack){var result;if(customizer){result=object?customizer(value,key,object,stack):customizer(value)}if(result!==undefined){return result}if(!isObject(value)){return value}var isArr=isArray(value);if(isArr){result=initCloneArray(value);if(!isDeep){return copyArray(value,result)}}else{var tag=getTag(value),isFunc=tag==funcTag||tag==genTag;if(isBuffer(value)){return cloneBuffer(value,isDeep)}if(tag==objectTag||tag==argsTag||isFunc&&!object){if(isHostObject(value)){return object?value:{}}result=initCloneObject(isFunc?{}:value);if(!isDeep){return copySymbols(value,baseAssign(result,value))}}else{if(!cloneableTags[tag]){return object?value:{}}result=initCloneByTag(value,tag,baseClone,isDeep)}}stack||(stack=new Stack);var stacked=stack.get(value);if(stacked){return stacked}stack.set(value,result);if(!isArr){var props=isFull?getAllKeys(value):keys(value)}arrayEach(props||value,function(subValue,key){if(props){key=subValue;subValue=value[key]}assignValue(result,key,baseClone(subValue,isDeep,isFull,customizer,key,value,stack))});return result}function baseCreate(proto){return isObject(proto)?objectCreate(proto):{}}function baseGetAllKeys(object,keysFunc,symbolsFunc){var result=keysFunc(object);return isArray(object)?result:arrayPush(result,symbolsFunc(object))}function baseGetTag(value){return objectToString.call(value)}function baseIsNative(value){if(!isObject(value)||isMasked(value)){return false}var pattern=isFunction(value)||isHostObject(value)?reIsNative:reIsHostCtor;return pattern.test(toSource(value))}function baseKeys(object){if(!isPrototype(object)){return nativeKeys(object)}var result=[];for(var key in Object(object)){if(hasOwnProperty.call(object,key)&&key!="constructor"){result.push(key)}}return result}function cloneBuffer(buffer,isDeep){if(isDeep){return buffer.slice()}var result=new buffer.constructor(buffer.length);buffer.copy(result);return result}function cloneArrayBuffer(arrayBuffer){var result=new arrayBuffer.constructor(arrayBuffer.byteLength);new Uint8Array(result).set(new Uint8Array(arrayBuffer));return result}function cloneDataView(dataView,isDeep){var buffer=isDeep?cloneArrayBuffer(dataView.buffer):dataView.buffer;return new dataView.constructor(buffer,dataView.byteOffset,dataView.byteLength)}function cloneMap(map,isDeep,cloneFunc){var array=isDeep?cloneFunc(mapToArray(map),true):mapToArray(map);return arrayReduce(array,addMapEntry,new map.constructor)}function cloneRegExp(regexp){var result=new regexp.constructor(regexp.source,reFlags.exec(regexp));result.lastIndex=regexp.lastIndex;return result}function cloneSet(set,isDeep,cloneFunc){var array=isDeep?cloneFunc(setToArray(set),true):setToArray(set);return arrayReduce(array,addSetEntry,new set.constructor)}function cloneSymbol(symbol){return symbolValueOf?Object(symbolValueOf.call(symbol)):{}}function cloneTypedArray(typedArray,isDeep){var buffer=isDeep?cloneArrayBuffer(typedArray.buffer):typedArray.buffer;return new typedArray.constructor(buffer,typedArray.byteOffset,typedArray.length)}function copyArray(source,array){var index=-1,length=source.length;array||(array=Array(length));while(++index<length){array[index]=source[index]}return array}function copyObject(source,props,object,customizer){object||(object={});var index=-1,length=props.length;while(++index<length){var key=props[index];var newValue=customizer?customizer(object[key],source[key],key,object,source):undefined;assignValue(object,key,newValue===undefined?source[key]:newValue)}return object}function copySymbols(source,object){return copyObject(source,getSymbols(source),object)}function getAllKeys(object){return baseGetAllKeys(object,keys,getSymbols)}function getMapData(map,key){var data=map.__data__;return isKeyable(key)?data[typeof key=="string"?"string":"hash"]:data.map}function getNative(object,key){var value=getValue(object,key);return baseIsNative(value)?value:undefined}var getSymbols=nativeGetSymbols?overArg(nativeGetSymbols,Object):stubArray;var getTag=baseGetTag;if(DataView&&getTag(new DataView(new ArrayBuffer(1)))!=dataViewTag||Map&&getTag(new Map)!=mapTag||Promise&&getTag(Promise.resolve())!=promiseTag||Set&&getTag(new Set)!=setTag||WeakMap&&getTag(new WeakMap)!=weakMapTag){getTag=function(value){var result=objectToString.call(value),Ctor=result==objectTag?value.constructor:undefined,ctorString=Ctor?toSource(Ctor):undefined;if(ctorString){switch(ctorString){
case dataViewCtorString:return dataViewTag;case mapCtorString:return mapTag;case promiseCtorString:return promiseTag;case setCtorString:return setTag;case weakMapCtorString:return weakMapTag}}return result}}function initCloneArray(array){var length=array.length,result=array.constructor(length);if(length&&typeof array[0]=="string"&&hasOwnProperty.call(array,"index")){result.index=array.index;result.input=array.input}return result}function initCloneObject(object){return typeof object.constructor=="function"&&!isPrototype(object)?baseCreate(getPrototype(object)):{}}function initCloneByTag(object,tag,cloneFunc,isDeep){var Ctor=object.constructor;switch(tag){case arrayBufferTag:return cloneArrayBuffer(object);case boolTag:case dateTag:return new Ctor(+object);case dataViewTag:return cloneDataView(object,isDeep);case float32Tag:case float64Tag:case int8Tag:case int16Tag:case int32Tag:case uint8Tag:case uint8ClampedTag:case uint16Tag:case uint32Tag:return cloneTypedArray(object,isDeep);case mapTag:return cloneMap(object,isDeep,cloneFunc);case numberTag:case stringTag:return new Ctor(object);case regexpTag:return cloneRegExp(object);case setTag:return cloneSet(object,isDeep,cloneFunc);case symbolTag:return cloneSymbol(object)}}function isIndex(value,length){length=length==null?MAX_SAFE_INTEGER:length;return!!length&&(typeof value=="number"||reIsUint.test(value))&&(value>-1&&value%1==0&&value<length)}function isKeyable(value){var type=typeof value;return type=="string"||type=="number"||type=="symbol"||type=="boolean"?value!=="__proto__":value===null}function isMasked(func){return!!maskSrcKey&&maskSrcKey in func}function isPrototype(value){var Ctor=value&&value.constructor,proto=typeof Ctor=="function"&&Ctor.prototype||objectProto;return value===proto}function toSource(func){if(func!=null){try{return funcToString.call(func)}catch(e){}try{return func+""}catch(e){}}return""}function cloneDeep(value){return baseClone(value,true,true)}function eq(value,other){return value===other||value!==value&&other!==other}function isArguments(value){return isArrayLikeObject(value)&&hasOwnProperty.call(value,"callee")&&(!propertyIsEnumerable.call(value,"callee")||objectToString.call(value)==argsTag)}var isArray=Array.isArray;function isArrayLike(value){return value!=null&&isLength(value.length)&&!isFunction(value)}function isArrayLikeObject(value){return isObjectLike(value)&&isArrayLike(value)}var isBuffer=nativeIsBuffer||stubFalse;function isFunction(value){var tag=isObject(value)?objectToString.call(value):"";return tag==funcTag||tag==genTag}function isLength(value){return typeof value=="number"&&value>-1&&value%1==0&&value<=MAX_SAFE_INTEGER}function isObject(value){var type=typeof value;return!!value&&(type=="object"||type=="function")}function isObjectLike(value){return!!value&&typeof value=="object"}function keys(object){return isArrayLike(object)?arrayLikeKeys(object):baseKeys(object)}function stubArray(){return[]}function stubFalse(){return false}module.exports=cloneDeep}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],6:[function(require,module,exports){var methods="assert,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,markTimeline,profile,profileEnd,time,timeEnd,trace,warn".split(",");var l=methods.length;var fn=function(){};var mockconsole={};while(l--){mockconsole[methods[l]]=fn}module.exports=mockconsole},{}],7:[function(require,module,exports){var process=module.exports={};var cachedSetTimeout;var cachedClearTimeout;function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}(function(){try{if(typeof setTimeout==="function"){cachedSetTimeout=setTimeout}else{cachedSetTimeout=defaultSetTimout}}catch(e){cachedSetTimeout=defaultSetTimout}try{if(typeof clearTimeout==="function"){cachedClearTimeout=clearTimeout}else{cachedClearTimeout=defaultClearTimeout}}catch(e){cachedClearTimeout=defaultClearTimeout}})();function runTimeout(fun){if(cachedSetTimeout===setTimeout){return setTimeout(fun,0)}if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout){cachedSetTimeout=setTimeout;return setTimeout(fun,0)}try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout){return clearTimeout(marker)}if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout){cachedClearTimeout=clearTimeout;return clearTimeout(marker)}try{return cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}var queue=[];var draining=false;var currentQueue;var queueIndex=-1;function cleanUpNextTick(){if(!draining||!currentQueue){return}draining=false;if(currentQueue.length){queue=currentQueue.concat(queue)}else{queueIndex=-1}if(queue.length){drainQueue()}}function drainQueue(){if(draining){return}var timeout=runTimeout(cleanUpNextTick);draining=true;var len=queue.length;while(len){currentQueue=queue;queue=[];while(++queueIndex<len){if(currentQueue){currentQueue[queueIndex].run()}}queueIndex=-1;len=queue.length}currentQueue=null;draining=false;runClearTimeout(timeout)}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1){for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i]}}queue.push(new Item(fun,args));if(queue.length===1&&!draining){runTimeout(drainQueue)}};function Item(fun,array){this.fun=fun;this.array=array}Item.prototype.run=function(){this.fun.apply(null,this.array)};process.title="browser";process.browser=true;process.env={};process.argv=[];process.version="";process.versions={};function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.prependListener=noop;process.prependOnceListener=noop;process.listeners=function(name){return[]};process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")};process.umask=function(){return 0}},{}],8:[function(require,module,exports){var util=require("util");var SJJ=require("sdp-jingle-json");var WildEmitter=require("wildemitter");var cloneDeep=require("lodash.clonedeep");function PeerConnection(config,constraints){var self=this;var item;WildEmitter.call(this);config=config||{};config.iceServers=config.iceServers||[];this.enableChromeNativeSimulcast=false;if(constraints&&constraints.optional&&window.chrome&&navigator.appVersion.match(/Chromium\//)===null){constraints.optional.forEach(function(constraint){if(constraint.enableChromeNativeSimulcast){self.enableChromeNativeSimulcast=true}})}this.enableMultiStreamHacks=false;if(constraints&&constraints.optional&&window.chrome){constraints.optional.forEach(function(constraint){if(constraint.enableMultiStreamHacks){self.enableMultiStreamHacks=true}})}this.restrictBandwidth=0;if(constraints&&constraints.optional){constraints.optional.forEach(function(constraint){if(constraint.andyetRestrictBandwidth){self.restrictBandwidth=constraint.andyetRestrictBandwidth}})}this.batchIceCandidates=0;if(constraints&&constraints.optional){constraints.optional.forEach(function(constraint){if(constraint.andyetBatchIce){self.batchIceCandidates=constraint.andyetBatchIce}})}this.batchedIceCandidates=[];if(constraints&&constraints.optional&&window.chrome){constraints.optional.forEach(function(constraint){if(constraint.andyetFasterICE){self.eliminateDuplicateCandidates=constraint.andyetFasterICE}})}if(constraints&&constraints.optional){constraints.optional.forEach(function(constraint){if(constraint.andyetDontSignalCandidates){self.dontSignalCandidates=constraint.andyetDontSignalCandidates}})}this.assumeSetLocalSuccess=false;if(constraints&&constraints.optional){constraints.optional.forEach(function(constraint){if(constraint.andyetAssumeSetLocalSuccess){self.assumeSetLocalSuccess=constraint.andyetAssumeSetLocalSuccess}})}if(window.navigator.mozGetUserMedia){if(constraints&&constraints.optional){this.wtFirefox=0;constraints.optional.forEach(function(constraint){if(constraint.andyetFirefoxMakesMeSad){self.wtFirefox=constraint.andyetFirefoxMakesMeSad;if(self.wtFirefox>0){self.firefoxcandidatebuffer=[]}}})}}this.pc=new RTCPeerConnection(config,constraints);if(typeof this.pc.getLocalStreams==="function"){this.getLocalStreams=this.pc.getLocalStreams.bind(this.pc)}else{this.getLocalStreams=function(){return[]}}if(typeof this.pc.getRemoteStreams==="function"){this.getRemoteStreams=this.pc.getRemoteStreams.bind(this.pc)}else{this.getRemoteStreams=function(){return[]}}this.addStream=this.pc.addStream.bind(this.pc);this.removeStream=function(stream){if(typeof self.pc.removeStream==="function"){self.pc.removeStream.apply(self.pc,arguments)}else if(typeof self.pc.removeTrack==="function"){stream.getTracks().forEach(function(track){self.pc.removeTrack(track)})}};if(typeof this.pc.removeTrack==="function"){this.removeTrack=this.pc.removeTrack.bind(this.pc)}this.pc.onremovestream=this.emit.bind(this,"removeStream");this.pc.onremovetrack=this.emit.bind(this,"removeTrack");this.pc.onaddstream=this.emit.bind(this,"addStream");this.pc.onnegotiationneeded=this.emit.bind(this,"negotiationNeeded");this.pc.oniceconnectionstatechange=this.emit.bind(this,"iceConnectionStateChange");this.pc.onsignalingstatechange=this.emit.bind(this,"signalingStateChange");this.pc.onicecandidate=this._onIce.bind(this);this.pc.ondatachannel=this._onDataChannel.bind(this);this.localDescription={contents:[]};this.remoteDescription={contents:[]};this.config={debug:false,sid:"",isInitiator:true,sdpSessionID:Date.now(),useJingle:false};this.iceCredentials={local:{},remote:{}};for(item in config){this.config[item]=config[item]}if(this.config.debug){this.on("*",function(){var logger=config.logger||console;logger.log("PeerConnection event:",arguments)})}this.hadLocalStunCandidate=false;this.hadRemoteStunCandidate=false;this.hadLocalRelayCandidate=false;this.hadRemoteRelayCandidate=false;this.hadLocalIPv6Candidate=false;this.hadRemoteIPv6Candidate=false;this._remoteDataChannels=[];this._localDataChannels=[];this._candidateBuffer=[]}util.inherits(PeerConnection,WildEmitter);Object.defineProperty(PeerConnection.prototype,"signalingState",{get:function(){return this.pc.signalingState}});Object.defineProperty(PeerConnection.prototype,"iceConnectionState",{get:function(){return this.pc.iceConnectionState}});PeerConnection.prototype._role=function(){return this.isInitiator?"initiator":"responder"};PeerConnection.prototype.addStream=function(stream){this.localStream=stream;this.pc.addStream(stream)};PeerConnection.prototype._checkLocalCandidate=function(candidate){var cand=SJJ.toCandidateJSON(candidate);if(cand.type=="srflx"){this.hadLocalStunCandidate=true}else if(cand.type=="relay"){this.hadLocalRelayCandidate=true}if(cand.ip.indexOf(":")!=-1){this.hadLocalIPv6Candidate=true}};PeerConnection.prototype._checkRemoteCandidate=function(candidate){var cand=SJJ.toCandidateJSON(candidate);if(cand.type=="srflx"){this.hadRemoteStunCandidate=true}else if(cand.type=="relay"){this.hadRemoteRelayCandidate=true}if(cand.ip.indexOf(":")!=-1){this.hadRemoteIPv6Candidate=true}};PeerConnection.prototype.processIce=function(update,cb){cb=cb||function(){};var self=this;if(this.pc.signalingState==="closed")return cb();if(update.contents||update.jingle&&update.jingle.contents){var contentNames=this.remoteDescription.contents.map(function(c){return c.name});var contents=update.contents||update.jingle.contents;contents.forEach(function(content){var transport=content.transport||{};var candidates=transport.candidates||[];var mline=contentNames.indexOf(content.name);var mid=content.name;var remoteContent=self.remoteDescription.contents.find(function(c){return c.name===content.name});var processCandidates=function(){candidates.forEach(function(candidate){var iceCandidate=SJJ.toCandidateSDP(candidate);self.pc.addIceCandidate(new RTCIceCandidate({candidate:iceCandidate,sdpMLineIndex:mline,sdpMid:mid}),function(){},function(err){self.emit("error",err)});self._checkRemoteCandidate(iceCandidate)});cb()};if(self.iceCredentials.remote[content.name]&&transport.ufrag&&self.iceCredentials.remote[content.name].ufrag!==transport.ufrag){if(remoteContent){remoteContent.transport.ufrag=transport.ufrag;remoteContent.transport.pwd=transport.pwd;var offer={type:"offer",jingle:self.remoteDescription};offer.sdp=SJJ.toSessionSDP(offer.jingle,{sid:self.config.sdpSessionID,role:self._role(),direction:"incoming"});self.pc.setRemoteDescription(new RTCSessionDescription(offer),function(){processCandidates()},function(err){self.emit("error",err)})}else{self.emit("error","ice restart failed to find matching content")}}else{processCandidates()}})}else{if(update.candidate&&update.candidate.candidate.indexOf("a=")!==0){update.candidate.candidate="a="+update.candidate.candidate}if(this.wtFirefox&&this.firefoxcandidatebuffer!==null){if(this.pc.localDescription&&this.pc.localDescription.type==="offer"){this.firefoxcandidatebuffer.push(update.candidate);return cb()}}self.pc.addIceCandidate(new RTCIceCandidate(update.candidate),function(){},function(err){self.emit("error",err)});self._checkRemoteCandidate(update.candidate.candidate);cb()}};PeerConnection.prototype.offer=function(constraints,cb){var self=this;var hasConstraints=arguments.length===2;var mediaConstraints=hasConstraints&&constraints?constraints:{offerToReceiveAudio:1,offerToReceiveVideo:1};cb=hasConstraints?cb:constraints;cb=cb||function(){};if(this.pc.signalingState==="closed")return cb("Already closed");this.pc.createOffer(function(offer){var expandedOffer={type:"offer",sdp:offer.sdp};if(self.assumeSetLocalSuccess){self.emit("offer",expandedOffer);cb(null,expandedOffer)}self._candidateBuffer=[];self.pc.setLocalDescription(offer,function(){var jingle;if(self.config.useJingle){jingle=SJJ.toSessionJSON(offer.sdp,{role:self._role(),direction:"outgoing"});jingle.sid=self.config.sid;self.localDescription=jingle;jingle.contents.forEach(function(content){var transport=content.transport||{};if(transport.ufrag){self.iceCredentials.local[content.name]={ufrag:transport.ufrag,pwd:transport.pwd}}});expandedOffer.jingle=jingle}expandedOffer.sdp.split("\r\n").forEach(function(line){if(line.indexOf("a=candidate:")===0){self._checkLocalCandidate(line)}});if(!self.assumeSetLocalSuccess){self.emit("offer",expandedOffer);cb(null,expandedOffer)}},function(err){self.emit("error",err);cb(err)})},function(err){self.emit("error",err);cb(err)},mediaConstraints)};PeerConnection.prototype.handleOffer=function(offer,cb){cb=cb||function(){};var self=this;offer.type="offer";if(offer.jingle){if(this.enableChromeNativeSimulcast){offer.jingle.contents.forEach(function(content){if(content.name==="video"){content.application.googConferenceFlag=true}})}if(this.enableMultiStreamHacks){offer.jingle.contents.forEach(function(content){if(content.name==="video"){var sources=content.application.sources||[];if(sources.length===0||sources[0].ssrc!=="3735928559"){sources.unshift({ssrc:"3735928559",parameters:[{key:"cname",value:"deadbeef"},{key:"msid",value:"mixyourfecintothis please"}]});content.application.sources=sources}}})}if(self.restrictBandwidth>0){if(offer.jingle.contents.length>=2&&offer.jingle.contents[1].name==="video"){var content=offer.jingle.contents[1];var hasBw=content.application&&content.application.bandwidth&&content.application.bandwidth.bandwidth;if(!hasBw){offer.jingle.contents[1].application.bandwidth={type:"AS",bandwidth:self.restrictBandwidth.toString()};offer.sdp=SJJ.toSessionSDP(offer.jingle,{sid:self.config.sdpSessionID,role:self._role(),direction:"outgoing"})}}}offer.jingle.contents.forEach(function(content){var transport=content.transport||{};if(transport.ufrag){self.iceCredentials.remote[content.name]={ufrag:transport.ufrag,pwd:transport.pwd}}});offer.sdp=SJJ.toSessionSDP(offer.jingle,{sid:self.config.sdpSessionID,role:self._role(),direction:"incoming"});self.remoteDescription=offer.jingle}offer.sdp.split("\r\n").forEach(function(line){if(line.indexOf("a=candidate:")===0){self._checkRemoteCandidate(line)}});self.pc.setRemoteDescription(new RTCSessionDescription(offer),function(){cb()},cb)};PeerConnection.prototype.answerAudioOnly=function(cb){var mediaConstraints={mandatory:{OfferToReceiveAudio:true,OfferToReceiveVideo:false}};this._answer(mediaConstraints,cb)};PeerConnection.prototype.answerBroadcastOnly=function(cb){var mediaConstraints={mandatory:{OfferToReceiveAudio:false,OfferToReceiveVideo:false}};this._answer(mediaConstraints,cb)};PeerConnection.prototype.answer=function(constraints,cb){var hasConstraints=arguments.length===2;var callback=hasConstraints?cb:constraints;var mediaConstraints=hasConstraints&&constraints?constraints:{mandatory:{OfferToReceiveAudio:true,OfferToReceiveVideo:true}};this._answer(mediaConstraints,callback)};PeerConnection.prototype.handleAnswer=function(answer,cb){cb=cb||function(){};var self=this;if(answer.jingle){answer.sdp=SJJ.toSessionSDP(answer.jingle,{sid:self.config.sdpSessionID,role:self._role(),direction:"incoming"});self.remoteDescription=answer.jingle;answer.jingle.contents.forEach(function(content){var transport=content.transport||{};if(transport.ufrag){self.iceCredentials.remote[content.name]={ufrag:transport.ufrag,pwd:transport.pwd}}})}answer.sdp.split("\r\n").forEach(function(line){if(line.indexOf("a=candidate:")===0){self._checkRemoteCandidate(line)}});self.pc.setRemoteDescription(new RTCSessionDescription(answer),function(){if(self.wtFirefox){window.setTimeout(function(){self.firefoxcandidatebuffer.forEach(function(candidate){self.pc.addIceCandidate(new RTCIceCandidate(candidate),function(){},function(err){self.emit("error",err)});self._checkRemoteCandidate(candidate.candidate)});self.firefoxcandidatebuffer=null},self.wtFirefox)}cb(null)},cb)};PeerConnection.prototype.close=function(){this.pc.close();this._localDataChannels=[];this._remoteDataChannels=[];this.emit("close")};PeerConnection.prototype._answer=function(constraints,cb){cb=cb||function(){};var self=this;if(!this.pc.remoteDescription){throw new Error("remoteDescription not set")}if(this.pc.signalingState==="closed")return cb("Already closed");self.pc.createAnswer(function(answer){var sim=[];if(self.enableChromeNativeSimulcast){answer.jingle=SJJ.toSessionJSON(answer.sdp,{role:self._role(),direction:"outgoing"});if(answer.jingle.contents.length>=2&&answer.jingle.contents[1].name==="video"){var groups=answer.jingle.contents[1].application.sourceGroups||[];var hasSim=false;groups.forEach(function(group){if(group.semantics=="SIM")hasSim=true});if(!hasSim&&answer.jingle.contents[1].application.sources.length){var newssrc=JSON.parse(JSON.stringify(answer.jingle.contents[1].application.sources[0]));newssrc.ssrc=""+Math.floor(Math.random()*4294967295);answer.jingle.contents[1].application.sources.push(newssrc);sim.push(answer.jingle.contents[1].application.sources[0].ssrc);sim.push(newssrc.ssrc);groups.push({semantics:"SIM",sources:sim});var rtxssrc=JSON.parse(JSON.stringify(newssrc));rtxssrc.ssrc=""+Math.floor(Math.random()*4294967295);answer.jingle.contents[1].application.sources.push(rtxssrc);groups.push({semantics:"FID",sources:[newssrc.ssrc,rtxssrc.ssrc]});answer.jingle.contents[1].application.sourceGroups=groups;answer.sdp=SJJ.toSessionSDP(answer.jingle,{sid:self.config.sdpSessionID,role:self._role(),direction:"outgoing"})}}}var expandedAnswer={type:"answer",sdp:answer.sdp};if(self.assumeSetLocalSuccess){var copy=cloneDeep(expandedAnswer);self.emit("answer",copy);cb(null,copy)}self._candidateBuffer=[];self.pc.setLocalDescription(answer,function(){if(self.config.useJingle){var jingle=SJJ.toSessionJSON(answer.sdp,{role:self._role(),direction:"outgoing"});jingle.sid=self.config.sid;self.localDescription=jingle;expandedAnswer.jingle=jingle}if(self.enableChromeNativeSimulcast){if(!expandedAnswer.jingle){expandedAnswer.jingle=SJJ.toSessionJSON(answer.sdp,{role:self._role(),direction:"outgoing"})}expandedAnswer.jingle.contents[1].application.sources.forEach(function(source,idx){source.parameters=source.parameters.map(function(parameter){if(parameter.key==="msid"){parameter.value+="-"+Math.floor(idx/2)}return parameter})});expandedAnswer.sdp=SJJ.toSessionSDP(expandedAnswer.jingle,{sid:self.sdpSessionID,role:self._role(),direction:"outgoing"})}expandedAnswer.sdp.split("\r\n").forEach(function(line){if(line.indexOf("a=candidate:")===0){self._checkLocalCandidate(line)}});if(!self.assumeSetLocalSuccess){var copy=cloneDeep(expandedAnswer);self.emit("answer",copy);cb(null,copy)}},function(err){self.emit("error",err);cb(err)})},function(err){self.emit("error",err);cb(err)},constraints)};PeerConnection.prototype._onIce=function(event){var self=this;if(event.candidate){if(this.dontSignalCandidates)return;var ice=event.candidate;var expandedCandidate={candidate:{candidate:ice.candidate,sdpMid:ice.sdpMid,sdpMLineIndex:ice.sdpMLineIndex}};this._checkLocalCandidate(ice.candidate);var cand=SJJ.toCandidateJSON(ice.candidate);var already;var idx;if(this.eliminateDuplicateCandidates&&cand.type==="relay"){already=this._candidateBuffer.filter(function(c){return c.type==="relay"}).map(function(c){return c.foundation+":"+c.component});idx=already.indexOf(cand.foundation+":"+cand.component);if(idx>-1&&cand.priority>>24>=already[idx].priority>>24){return}}if(this.config.bundlePolicy==="max-bundle"){already=this._candidateBuffer.filter(function(c){return cand.type===c.type}).map(function(cand){return cand.address+":"+cand.port});idx=already.indexOf(cand.address+":"+cand.port);if(idx>-1)return}if(this.config.rtcpMuxPolicy==="require"&&cand.component==="2"){return}this._candidateBuffer.push(cand);if(self.config.useJingle){if(!ice.sdpMid){if(self.pc.remoteDescription&&self.pc.remoteDescription.type==="offer"){ice.sdpMid=self.remoteDescription.contents[ice.sdpMLineIndex].name}else{ice.sdpMid=self.localDescription.contents[ice.sdpMLineIndex].name}}if(!self.iceCredentials.local[ice.sdpMid]){var jingle=SJJ.toSessionJSON(self.pc.localDescription.sdp,{role:self._role(),direction:"outgoing"});jingle.contents.forEach(function(content){var transport=content.transport||{};if(transport.ufrag){self.iceCredentials.local[content.name]={ufrag:transport.ufrag,pwd:transport.pwd}}})}expandedCandidate.jingle={contents:[{name:ice.sdpMid,creator:self._role(),transport:{transportType:"iceUdp",ufrag:self.iceCredentials.local[ice.sdpMid].ufrag,pwd:self.iceCredentials.local[ice.sdpMid].pwd,candidates:[cand]}}]};if(self.batchIceCandidates>0){if(self.batchedIceCandidates.length===0){window.setTimeout(function(){var contents={};self.batchedIceCandidates.forEach(function(content){content=content.contents[0];if(!contents[content.name])contents[content.name]=content;contents[content.name].transport.candidates.push(content.transport.candidates[0])});var newCand={jingle:{contents:[]}};Object.keys(contents).forEach(function(name){newCand.jingle.contents.push(contents[name])});self.batchedIceCandidates=[];self.emit("ice",newCand)},self.batchIceCandidates)}self.batchedIceCandidates.push(expandedCandidate.jingle);return}}this.emit("ice",expandedCandidate)}else{this.emit("endOfCandidates")}};PeerConnection.prototype._onDataChannel=function(event){var channel=event.channel;this._remoteDataChannels.push(channel);this.emit("addChannel",channel)};PeerConnection.prototype.createDataChannel=function(name,opts){var channel=this.pc.createDataChannel(name,opts);this._localDataChannels.push(channel);return channel};PeerConnection.prototype.getStats=function(){if(typeof arguments[0]==="function"){var cb=arguments[0];this.pc.getStats().then(function(res){cb(null,res)},function(err){cb(err)})}else{return this.pc.getStats.apply(this.pc,arguments)}};module.exports=PeerConnection},{"lodash.clonedeep":5,"sdp-jingle-json":9,util:16,wildemitter:18}],9:[function(require,module,exports){var toSDP=require("./lib/tosdp");var toJSON=require("./lib/tojson");exports.toIncomingSDPOffer=function(session){return toSDP.toSessionSDP(session,{role:"responder",direction:"incoming"})};exports.toOutgoingSDPOffer=function(session){return toSDP.toSessionSDP(session,{role:"initiator",direction:"outgoing"})};exports.toIncomingSDPAnswer=function(session){return toSDP.toSessionSDP(session,{role:"initiator",direction:"incoming"})};exports.toOutgoingSDPAnswer=function(session){return toSDP.toSessionSDP(session,{role:"responder",direction:"outgoing"})};exports.toIncomingMediaSDPOffer=function(media){return toSDP.toMediaSDP(media,{role:"responder",direction:"incoming"})};exports.toOutgoingMediaSDPOffer=function(media){return toSDP.toMediaSDP(media,{role:"initiator",direction:"outgoing"})};exports.toIncomingMediaSDPAnswer=function(media){return toSDP.toMediaSDP(media,{role:"initiator",direction:"incoming"})};exports.toOutgoingMediaSDPAnswer=function(media){return toSDP.toMediaSDP(media,{role:"responder",direction:"outgoing"})};exports.toCandidateSDP=toSDP.toCandidateSDP;exports.toMediaSDP=toSDP.toMediaSDP;exports.toSessionSDP=toSDP.toSessionSDP;exports.toIncomingJSONOffer=function(sdp,creators){return toJSON.toSessionJSON(sdp,{role:"responder",direction:"incoming",creators:creators})};exports.toOutgoingJSONOffer=function(sdp,creators){return toJSON.toSessionJSON(sdp,{role:"initiator",direction:"outgoing",creators:creators})};exports.toIncomingJSONAnswer=function(sdp,creators){return toJSON.toSessionJSON(sdp,{role:"initiator",direction:"incoming",creators:creators})};exports.toOutgoingJSONAnswer=function(sdp,creators){return toJSON.toSessionJSON(sdp,{role:"responder",direction:"outgoing",creators:creators})};exports.toIncomingMediaJSONOffer=function(sdp,creator){return toJSON.toMediaJSON(sdp,{role:"responder",direction:"incoming",creator:creator})};exports.toOutgoingMediaJSONOffer=function(sdp,creator){return toJSON.toMediaJSON(sdp,{role:"initiator",direction:"outgoing",creator:creator})};exports.toIncomingMediaJSONAnswer=function(sdp,creator){return toJSON.toMediaJSON(sdp,{role:"initiator",direction:"incoming",creator:creator})};exports.toOutgoingMediaJSONAnswer=function(sdp,creator){return toJSON.toMediaJSON(sdp,{role:"responder",direction:"outgoing",creator:creator})};exports.toCandidateJSON=toJSON.toCandidateJSON;exports.toMediaJSON=toJSON.toMediaJSON;exports.toSessionJSON=toJSON.toSessionJSON},{"./lib/tojson":12,"./lib/tosdp":13}],10:[function(require,module,exports){exports.lines=function(sdp){return sdp.split("\r\n").filter(function(line){return line.length>0})};exports.findLine=function(prefix,mediaLines,sessionLines){var prefixLength=prefix.length;for(var i=0;i<mediaLines.length;i++){if(mediaLines[i].substr(0,prefixLength)===prefix){return mediaLines[i]}}if(!sessionLines){return false}for(var j=0;j<sessionLines.length;j++){if(sessionLines[j].substr(0,prefixLength)===prefix){return sessionLines[j]}}return false};exports.findLines=function(prefix,mediaLines,sessionLines){var results=[];var prefixLength=prefix.length;for(var i=0;i<mediaLines.length;i++){if(mediaLines[i].substr(0,prefixLength)===prefix){results.push(mediaLines[i])}}if(results.length||!sessionLines){return results}for(var j=0;j<sessionLines.length;j++){if(sessionLines[j].substr(0,prefixLength)===prefix){results.push(sessionLines[j])}}return results};exports.mline=function(line){var parts=line.substr(2).split(" ");var parsed={media:parts[0],port:parts[1],proto:parts[2],formats:[]};for(var i=3;i<parts.length;i++){if(parts[i]){parsed.formats.push(parts[i])}}return parsed};exports.rtpmap=function(line){var parts=line.substr(9).split(" ");var parsed={id:parts.shift()};parts=parts[0].split("/");parsed.name=parts[0];parsed.clockrate=parts[1];parsed.channels=parts.length==3?parts[2]:"1";return parsed};exports.sctpmap=function(line){var parts=line.substr(10).split(" ");var parsed={number:parts.shift(),protocol:parts.shift(),streams:parts.shift()};return parsed};exports.fmtp=function(line){var kv,key,value;var parts=line.substr(line.indexOf(" ")+1).split(";");var parsed=[];for(var i=0;i<parts.length;i++){kv=parts[i].split("=");key=kv[0].trim();value=kv[1];if(key&&value){parsed.push({key:key,value:value})}else if(key){parsed.push({key:"",value:key})}}return parsed};exports.crypto=function(line){var parts=line.substr(9).split(" ");var parsed={tag:parts[0],cipherSuite:parts[1],keyParams:parts[2],sessionParams:parts.slice(3).join(" ")};return parsed};exports.fingerprint=function(line){var parts=line.substr(14).split(" ");return{hash:parts[0],value:parts[1]}};exports.extmap=function(line){var parts=line.substr(9).split(" ");var parsed={};var idpart=parts.shift();var sp=idpart.indexOf("/");if(sp>=0){parsed.id=idpart.substr(0,sp);parsed.senders=idpart.substr(sp+1)}else{parsed.id=idpart;parsed.senders="sendrecv"}parsed.uri=parts.shift()||"";return parsed};exports.rtcpfb=function(line){var parts=line.substr(10).split(" ");var parsed={};parsed.id=parts.shift();parsed.type=parts.shift();if(parsed.type==="trr-int"){parsed.value=parts.shift()}else{parsed.subtype=parts.shift()||""}parsed.parameters=parts;return parsed};exports.candidate=function(line){var parts;if(line.indexOf("a=candidate:")===0){parts=line.substring(12).split(" ")}else{parts=line.substring(10).split(" ")}var candidate={foundation:parts[0],component:parts[1],protocol:parts[2].toLowerCase(),priority:parts[3],ip:parts[4],port:parts[5],type:parts[7],generation:"0"};for(var i=8;i<parts.length;i+=2){if(parts[i]==="raddr"){candidate.relAddr=parts[i+1]}else if(parts[i]==="rport"){candidate.relPort=parts[i+1]}else if(parts[i]==="generation"){candidate.generation=parts[i+1]}else if(parts[i]==="tcptype"){candidate.tcpType=parts[i+1]}}candidate.network="1";return candidate};exports.sourceGroups=function(lines){var parsed=[];for(var i=0;i<lines.length;i++){var parts=lines[i].substr(13).split(" ");parsed.push({semantics:parts.shift(),sources:parts})}return parsed};exports.sources=function(lines){var parsed=[];var sources={};for(var i=0;i<lines.length;i++){var parts=lines[i].substr(7).split(" ");var ssrc=parts.shift();if(!sources[ssrc]){var source={ssrc:ssrc,parameters:[]};parsed.push(source);sources[ssrc]=source}parts=parts.join(" ").split(":");var attribute=parts.shift();var value=parts.join(":")||null;sources[ssrc].parameters.push({key:attribute,value:value})}return parsed};exports.groups=function(lines){var parsed=[];var parts;for(var i=0;i<lines.length;i++){parts=lines[i].substr(8).split(" ");parsed.push({semantics:parts.shift(),contents:parts})}return parsed};exports.bandwidth=function(line){var parts=line.substr(2).split(":");var parsed={};parsed.type=parts.shift();parsed.bandwidth=parts.shift();return parsed};exports.msid=function(line){var data=line.substr(7);var parts=data.split(" ");return{msid:data,mslabel:parts[0],label:parts[1]}}},{}],11:[function(require,module,exports){module.exports={initiator:{incoming:{initiator:"recvonly",responder:"sendonly",both:"sendrecv",none:"inactive",recvonly:"initiator",sendonly:"responder",sendrecv:"both",inactive:"none"},outgoing:{initiator:"sendonly",responder:"recvonly",both:"sendrecv",none:"inactive",recvonly:"responder",sendonly:"initiator",sendrecv:"both",inactive:"none"}},responder:{incoming:{initiator:"sendonly",responder:"recvonly",both:"sendrecv",none:"inactive",recvonly:"responder",sendonly:"initiator",sendrecv:"both",inactive:"none"},outgoing:{initiator:"recvonly",responder:"sendonly",both:"sendrecv",none:"inactive",recvonly:"initiator",sendonly:"responder",sendrecv:"both",inactive:"none"}}}},{}],12:[function(require,module,exports){var SENDERS=require("./senders");var parsers=require("./parsers");var idCounter=Math.random();exports._setIdCounter=function(counter){idCounter=counter};exports.toSessionJSON=function(sdp,opts){var i
;var creators=opts.creators||[];var role=opts.role||"initiator";var direction=opts.direction||"outgoing";var media=sdp.split("\r\nm=");for(i=1;i<media.length;i++){media[i]="m="+media[i];if(i!==media.length-1){media[i]+="\r\n"}}var session=media.shift()+"\r\n";var sessionLines=parsers.lines(session);var parsed={};var contents=[];for(i=0;i<media.length;i++){contents.push(exports.toMediaJSON(media[i],session,{role:role,direction:direction,creator:creators[i]||"initiator"}))}parsed.contents=contents;var groupLines=parsers.findLines("a=group:",sessionLines);if(groupLines.length){parsed.groups=parsers.groups(groupLines)}return parsed};exports.toMediaJSON=function(media,session,opts){var creator=opts.creator||"initiator";var role=opts.role||"initiator";var direction=opts.direction||"outgoing";var lines=parsers.lines(media);var sessionLines=parsers.lines(session);var mline=parsers.mline(lines[0]);var content={creator:creator,name:mline.media,application:{applicationType:"rtp",media:mline.media,payloads:[],encryption:[],feedback:[],headerExtensions:[]},transport:{transportType:"iceUdp",candidates:[],fingerprints:[]}};if(mline.media=="application"){content.application={applicationType:"datachannel"};content.transport.sctp=[]}var desc=content.application;var trans=content.transport;var mid=parsers.findLine("a=mid:",lines);if(mid){content.name=mid.substr(6)}if(parsers.findLine("a=sendrecv",lines,sessionLines)){content.senders="both"}else if(parsers.findLine("a=sendonly",lines,sessionLines)){content.senders=SENDERS[role][direction].sendonly}else if(parsers.findLine("a=recvonly",lines,sessionLines)){content.senders=SENDERS[role][direction].recvonly}else if(parsers.findLine("a=inactive",lines,sessionLines)){content.senders="none"}if(desc.applicationType=="rtp"){var bandwidth=parsers.findLine("b=",lines);if(bandwidth){desc.bandwidth=parsers.bandwidth(bandwidth)}var ssrc=parsers.findLine("a=ssrc:",lines);if(ssrc){desc.ssrc=ssrc.substr(7).split(" ")[0]}var rtpmapLines=parsers.findLines("a=rtpmap:",lines);rtpmapLines.forEach(function(line){var payload=parsers.rtpmap(line);payload.parameters=[];payload.feedback=[];var fmtpLines=parsers.findLines("a=fmtp:"+payload.id,lines);fmtpLines.forEach(function(line){payload.parameters=parsers.fmtp(line)});var fbLines=parsers.findLines("a=rtcp-fb:"+payload.id,lines);fbLines.forEach(function(line){payload.feedback.push(parsers.rtcpfb(line))});desc.payloads.push(payload)});var cryptoLines=parsers.findLines("a=crypto:",lines,sessionLines);cryptoLines.forEach(function(line){desc.encryption.push(parsers.crypto(line))});if(parsers.findLine("a=rtcp-mux",lines)){desc.mux=true}var fbLines=parsers.findLines("a=rtcp-fb:*",lines);fbLines.forEach(function(line){desc.feedback.push(parsers.rtcpfb(line))});var extLines=parsers.findLines("a=extmap:",lines);extLines.forEach(function(line){var ext=parsers.extmap(line);ext.senders=SENDERS[role][direction][ext.senders];desc.headerExtensions.push(ext)});var ssrcGroupLines=parsers.findLines("a=ssrc-group:",lines);desc.sourceGroups=parsers.sourceGroups(ssrcGroupLines||[]);var ssrcLines=parsers.findLines("a=ssrc:",lines);var sources=desc.sources=parsers.sources(ssrcLines||[]);var msidLine=parsers.findLine("a=msid:",lines);if(msidLine){var msid=parsers.msid(msidLine);["msid","mslabel","label"].forEach(function(key){for(var i=0;i<sources.length;i++){var found=false;for(var j=0;j<sources[i].parameters.length;j++){if(sources[i].parameters[j].key===key){found=true}}if(!found){sources[i].parameters.push({key:key,value:msid[key]})}}})}if(parsers.findLine("a=x-google-flag:conference",lines,sessionLines)){desc.googConferenceFlag=true}}var fingerprintLines=parsers.findLines("a=fingerprint:",lines,sessionLines);var setup=parsers.findLine("a=setup:",lines,sessionLines);fingerprintLines.forEach(function(line){var fp=parsers.fingerprint(line);if(setup){fp.setup=setup.substr(8)}trans.fingerprints.push(fp)});var ufragLine=parsers.findLine("a=ice-ufrag:",lines,sessionLines);var pwdLine=parsers.findLine("a=ice-pwd:",lines,sessionLines);if(ufragLine&&pwdLine){trans.ufrag=ufragLine.substr(12);trans.pwd=pwdLine.substr(10);trans.candidates=[];var candidateLines=parsers.findLines("a=candidate:",lines,sessionLines);candidateLines.forEach(function(line){trans.candidates.push(exports.toCandidateJSON(line))})}if(desc.applicationType=="datachannel"){var sctpmapLines=parsers.findLines("a=sctpmap:",lines);sctpmapLines.forEach(function(line){var sctp=parsers.sctpmap(line);trans.sctp.push(sctp)})}return content};exports.toCandidateJSON=function(line){var candidate=parsers.candidate(line.split("\r\n")[0]);candidate.id=(idCounter++).toString(36).substr(0,12);return candidate}},{"./parsers":10,"./senders":11}],13:[function(require,module,exports){var SENDERS=require("./senders");exports.toSessionSDP=function(session,opts){var role=opts.role||"initiator";var direction=opts.direction||"outgoing";var sid=opts.sid||session.sid||Date.now();var time=opts.time||Date.now();var sdp=["v=0","o=- "+sid+" "+time+" IN IP4 0.0.0.0","s=-","t=0 0"];var contents=session.contents||[];var hasSources=false;contents.forEach(function(content){if(content.application.sources&&content.application.sources.length){hasSources=true}});if(hasSources){sdp.push("a=msid-semantic: WMS *")}var groups=session.groups||[];groups.forEach(function(group){sdp.push("a=group:"+group.semantics+" "+group.contents.join(" "))});contents.forEach(function(content){sdp.push(exports.toMediaSDP(content,opts))});return sdp.join("\r\n")+"\r\n"};exports.toMediaSDP=function(content,opts){var sdp=[];var role=opts.role||"initiator";var direction=opts.direction||"outgoing";var desc=content.application;var transport=content.transport;var payloads=desc.payloads||[];var fingerprints=transport&&transport.fingerprints||[];var mline=[];if(desc.applicationType=="datachannel"){mline.push("application");mline.push("1");mline.push("DTLS/SCTP");if(transport.sctp){transport.sctp.forEach(function(map){mline.push(map.number)})}}else{mline.push(desc.media);mline.push("1");if(fingerprints.length>0){mline.push("UDP/TLS/RTP/SAVPF")}else if(desc.encryption&&desc.encryption.length>0){mline.push("RTP/SAVPF")}else{mline.push("RTP/AVPF")}payloads.forEach(function(payload){mline.push(payload.id)})}sdp.push("m="+mline.join(" "));sdp.push("c=IN IP4 0.0.0.0");if(desc.bandwidth&&desc.bandwidth.type&&desc.bandwidth.bandwidth){sdp.push("b="+desc.bandwidth.type+":"+desc.bandwidth.bandwidth)}if(desc.applicationType=="rtp"){sdp.push("a=rtcp:1 IN IP4 0.0.0.0")}if(transport){if(transport.ufrag){sdp.push("a=ice-ufrag:"+transport.ufrag)}if(transport.pwd){sdp.push("a=ice-pwd:"+transport.pwd)}var pushedSetup=false;fingerprints.forEach(function(fingerprint){sdp.push("a=fingerprint:"+fingerprint.hash+" "+fingerprint.value);if(fingerprint.setup&&!pushedSetup){sdp.push("a=setup:"+fingerprint.setup)}});if(transport.sctp){transport.sctp.forEach(function(map){sdp.push("a=sctpmap:"+map.number+" "+map.protocol+" "+map.streams)})}}if(desc.applicationType=="rtp"){sdp.push("a="+(SENDERS[role][direction][content.senders]||"sendrecv"))}sdp.push("a=mid:"+content.name);if(desc.sources&&desc.sources.length){(desc.sources[0].parameters||[]).forEach(function(param){if(param.key==="msid"){sdp.push("a=msid:"+param.value)}})}if(desc.mux){sdp.push("a=rtcp-mux")}var encryption=desc.encryption||[];encryption.forEach(function(crypto){sdp.push("a=crypto:"+crypto.tag+" "+crypto.cipherSuite+" "+crypto.keyParams+(crypto.sessionParams?" "+crypto.sessionParams:""))});if(desc.googConferenceFlag){sdp.push("a=x-google-flag:conference")}payloads.forEach(function(payload){var rtpmap="a=rtpmap:"+payload.id+" "+payload.name+"/"+payload.clockrate;if(payload.channels&&payload.channels!="1"){rtpmap+="/"+payload.channels}sdp.push(rtpmap);if(payload.parameters&&payload.parameters.length){var fmtp=["a=fmtp:"+payload.id];var parameters=[];payload.parameters.forEach(function(param){parameters.push((param.key?param.key+"=":"")+param.value)});fmtp.push(parameters.join(";"));sdp.push(fmtp.join(" "))}if(payload.feedback){payload.feedback.forEach(function(fb){if(fb.type==="trr-int"){sdp.push("a=rtcp-fb:"+payload.id+" trr-int "+(fb.value?fb.value:"0"))}else{sdp.push("a=rtcp-fb:"+payload.id+" "+fb.type+(fb.subtype?" "+fb.subtype:""))}})}});if(desc.feedback){desc.feedback.forEach(function(fb){if(fb.type==="trr-int"){sdp.push("a=rtcp-fb:* trr-int "+(fb.value?fb.value:"0"))}else{sdp.push("a=rtcp-fb:* "+fb.type+(fb.subtype?" "+fb.subtype:""))}})}var hdrExts=desc.headerExtensions||[];hdrExts.forEach(function(hdr){sdp.push("a=extmap:"+hdr.id+(hdr.senders?"/"+SENDERS[role][direction][hdr.senders]:"")+" "+hdr.uri)});var ssrcGroups=desc.sourceGroups||[];ssrcGroups.forEach(function(ssrcGroup){sdp.push("a=ssrc-group:"+ssrcGroup.semantics+" "+ssrcGroup.sources.join(" "))});var ssrcs=desc.sources||[];ssrcs.forEach(function(ssrc){for(var i=0;i<ssrc.parameters.length;i++){var param=ssrc.parameters[i];sdp.push("a=ssrc:"+(ssrc.ssrc||desc.ssrc)+" "+param.key+(param.value?":"+param.value:""))}});var candidates=transport.candidates||[];candidates.forEach(function(candidate){sdp.push(exports.toCandidateSDP(candidate))});return sdp.join("\r\n")};exports.toCandidateSDP=function(candidate){var sdp=[];sdp.push(candidate.foundation);sdp.push(candidate.component);sdp.push(candidate.protocol.toUpperCase());sdp.push(candidate.priority);sdp.push(candidate.ip);sdp.push(candidate.port);var type=candidate.type;sdp.push("typ");sdp.push(type);if(type==="srflx"||type==="prflx"||type==="relay"){if(candidate.relAddr&&candidate.relPort){sdp.push("raddr");sdp.push(candidate.relAddr);sdp.push("rport");sdp.push(candidate.relPort)}}if(candidate.tcpType&&candidate.protocol.toUpperCase()=="TCP"){sdp.push("tcptype");sdp.push(candidate.tcpType)}sdp.push("generation");sdp.push(candidate.generation||"0");return"a=candidate:"+sdp.join(" ")}},{"./senders":11}],14:[function(require,module,exports){if(typeof Object.create==="function"){module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})}}else{module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype;ctor.prototype=new TempCtor;ctor.prototype.constructor=ctor}}},{}],15:[function(require,module,exports){module.exports=function isBuffer(arg){return arg&&typeof arg==="object"&&typeof arg.copy==="function"&&typeof arg.fill==="function"&&typeof arg.readUInt8==="function"}},{}],16:[function(require,module,exports){(function(process,global){var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(inspect(arguments[i]))}return objects.join(" ")}var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,function(x){if(x==="%%")return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}});for(var x=args[i];i<len;x=args[++i]){if(isNull(x)||!isObject(x)){str+=" "+x}else{str+=" "+inspect(x)}}return str};exports.deprecate=function(fn,msg){if(isUndefined(global.process)){return function(){return exports.deprecate(fn,msg).apply(this,arguments)}}if(process.noDeprecation===true){return fn}var warned=false;function deprecated(){if(!warned){if(process.throwDeprecation){throw new Error(msg)}else if(process.traceDeprecation){console.trace(msg)}else{console.error(msg)}warned=true}return fn.apply(this,arguments)}return deprecated};var debugs={};var debugEnviron;exports.debuglog=function(set){if(isUndefined(debugEnviron))debugEnviron=process.env.NODE_DEBUG||"";set=set.toUpperCase();if(!debugs[set]){if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error("%s %d: %s",set,pid,msg)}}else{debugs[set]=function(){}}}return debugs[set]};function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};if(arguments.length>=3)ctx.depth=arguments[2];if(arguments.length>=4)ctx.colors=arguments[3];if(isBoolean(opts)){ctx.showHidden=opts}else if(opts){exports._extend(ctx,opts)}if(isUndefined(ctx.showHidden))ctx.showHidden=false;if(isUndefined(ctx.depth))ctx.depth=2;if(isUndefined(ctx.colors))ctx.colors=false;if(isUndefined(ctx.customInspect))ctx.customInspect=true;if(ctx.colors)ctx.stylize=stylizeWithColor;return formatValue(ctx,obj,ctx.depth)}exports.inspect=inspect;inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]};inspect.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"};function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];if(style){return"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m"}else{return str}}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};array.forEach(function(val,idx){hash[val]=true});return hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&!(value.constructor&&value.constructor.prototype===value)){var ret=value.inspect(recurseTimes,ctx);if(!isString(ret)){ret=formatValue(ctx,ret,recurseTimes)}return ret}var primitive=formatPrimitive(ctx,value);if(primitive){return primitive}var keys=Object.keys(value);var visibleKeys=arrayToHash(keys);if(ctx.showHidden){keys=Object.getOwnPropertyNames(value)}if(isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0)){return formatError(value)}if(keys.length===0){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}if(isDate(value)){return ctx.stylize(Date.prototype.toString.call(value),"date")}if(isError(value)){return formatError(value)}}var base="",array=false,braces=["{","}"];if(isArray(value)){array=true;braces=["[","]"]}if(isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)){base=" "+RegExp.prototype.toString.call(value)}if(isDate(value)){base=" "+Date.prototype.toUTCString.call(value)}if(isError(value)){base=" "+formatError(value)}if(keys.length===0&&(!array||value.length==0)){return braces[0]+base+braces[1]}if(recurseTimes<0){if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}else{return ctx.stylize("[Object]","special")}}ctx.seen.push(value);var output;if(array){output=formatArray(ctx,value,recurseTimes,visibleKeys,keys)}else{output=keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)})}ctx.seen.pop();return reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}if(isNumber(value))return ctx.stylize(""+value,"number");if(isBoolean(value))return ctx.stylize(""+value,"boolean");if(isNull(value))return ctx.stylize("null","null")}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){var output=[];for(var i=0,l=value.length;i<l;++i){if(hasOwnProperty(value,String(i))){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),true))}else{output.push("")}}keys.forEach(function(key){if(!key.match(/^\d+$/)){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,true))}});return output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]};if(desc.get){if(desc.set){str=ctx.stylize("[Getter/Setter]","special")}else{str=ctx.stylize("[Getter]","special")}}else{if(desc.set){str=ctx.stylize("[Setter]","special")}}if(!hasOwnProperty(visibleKeys,key)){name="["+key+"]"}if(!str){if(ctx.seen.indexOf(desc.value)<0){if(isNull(recurseTimes)){str=formatValue(ctx,desc.value,null)}else{str=formatValue(ctx,desc.value,recurseTimes-1)}if(str.indexOf("\n")>-1){if(array){str=str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2)}else{str="\n"+str.split("\n").map(function(line){return"   "+line}).join("\n")}}}else{str=ctx.stylize("[Circular]","special")}}if(isUndefined(name)){if(array&&key.match(/^\d+$/)){return str}name=JSON.stringify(""+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){name=name.substr(1,name.length-2);name=ctx.stylize(name,"name")}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=ctx.stylize(name,"string")}}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0;var length=output.reduce(function(prev,cur){numLinesEst++;if(cur.indexOf("\n")>=0)numLinesEst++;return prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);if(length>60){return braces[0]+(base===""?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]}return braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return Array.isArray(ar)}exports.isArray=isArray;function isBoolean(arg){return typeof arg==="boolean"}exports.isBoolean=isBoolean;function isNull(arg){return arg===null}exports.isNull=isNull;function isNullOrUndefined(arg){return arg==null}exports.isNullOrUndefined=isNullOrUndefined;function isNumber(arg){return typeof arg==="number"}exports.isNumber=isNumber;function isString(arg){return typeof arg==="string"}exports.isString=isString;function isSymbol(arg){return typeof arg==="symbol"}exports.isSymbol=isSymbol;function isUndefined(arg){return arg===void 0}exports.isUndefined=isUndefined;function isRegExp(re){return isObject(re)&&objectToString(re)==="[object RegExp]"}exports.isRegExp=isRegExp;function isObject(arg){return typeof arg==="object"&&arg!==null}exports.isObject=isObject;function isDate(d){return isObject(d)&&objectToString(d)==="[object Date]"}exports.isDate=isDate;function isError(e){return isObject(e)&&(objectToString(e)==="[object Error]"||e instanceof Error)}exports.isError=isError;function isFunction(arg){return typeof arg==="function"}exports.isFunction=isFunction;function isPrimitive(arg){return arg===null||typeof arg==="boolean"||typeof arg==="number"||typeof arg==="string"||typeof arg==="symbol"||typeof arg==="undefined"}exports.isPrimitive=isPrimitive;exports.isBuffer=require("./support/isBuffer");function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return n<10?"0"+n.toString(10):n.toString(10)}var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function timestamp(){var d=new Date;var time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))};exports.inherits=require("inherits");exports._extend=function(origin,add){if(!add||!isObject(add))return origin;var keys=Object.keys(add);var i=keys.length;while(i--){origin[keys[i]]=add[keys[i]]}return origin};function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./support/isBuffer":15,_process:7,inherits:14}],17:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _events=require("events");function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var IS_BROWSER=void 0;var StatsGatherer=function(_EventEmitter){_inherits(StatsGatherer,_EventEmitter);function StatsGatherer(peerConnection){var opts=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};_classCallCheck(this,StatsGatherer);IS_BROWSER=typeof window!=="undefined";var _this=_possibleConstructorReturn(this,(StatsGatherer.__proto__||Object.getPrototypeOf(StatsGatherer)).call(this));_this.connection=peerConnection;_this.session=opts.session;_this.initiator=opts.initiator;_this.conference=opts.conference;_this.statsInterval=(opts.interval||5)*1e3;_this.lastResult={};_this.lastActiveLocalCandidate=null;_this._pollingInterval=null;_this._haveConnectionMetrics=false;_this._iceStartTime=null;_this._iceConnectionTime=null;_this.traceData=[];_this.logger=opts.logger||console;_this.collectTraces();return _this}_createClass(StatsGatherer,[{key:"_polyFillStats",value:function _polyFillStats(results){if(!results||Array.isArray(results)){return results}var betterResults=[];if(typeof window.RTCStatsReport!=="undefined"&&results instanceof window.RTCStatsReport){results.forEach(function(value,key){betterResults.push({key:key,value:value})})}else if(Object.keys(results).length>0){Object.keys(results).forEach(function(key){betterResults.push({key:key,value:results[key]})})}else{this.logger.warn("Unknown stats results format, returning unmodified",results);return results}return betterResults}},{key:"_gatherStats",value:function _gatherStats(){try{if(this.connection.pc.peerconnection){return this.connection.pc.peerconnection.getStats(null).then(this._polyFillStats)}return this.connection.pc.getStats(null).then(this._polyFillStats)}catch(e){this.logger.error("Failed to gather stats. Are you using RTCPeerConnection as your connection? {expect connection.pc.peerconnection.getStats}",this.connection);return Promise.reject(e)}}},{key:"_checkLastActiveCandidate",value:function _checkLastActiveCandidate(_ref){var localId=_ref.localId,remoteId=_ref.remoteId,key=_ref.key,report=_ref.report;if(localId&&report.type==="localcandidate"&&report.id===localId){this.lastActiveLocalCandidate=report}if(remoteId&&report.type==="remotecandidate"&&report.id===remoteId){this.lastActiveRemoteCandidate=report}}},{key:"_processReport",value:function _processReport(_ref2){var _this2=this;var key=_ref2.key,report=_ref2.report,results=_ref2.results,event=_ref2.event;var now=new Date(report.timestamp);var track=report.trackIdentifier||report.googTrackId||key;var kind=report.mediaType;var activeSource=!!(report.type==="ssrc"&&(report.bytesSent||report.bytesReceived));if(!activeSource){var selected=report.type==="candidatepair"&&report.selected;var specSepected=report.type==="candidate-pair"&&report.nominated&&report.state==="succeeded";var chromeSelected=report.type==="googCandidatePair"&&report.googActiveConnection==="true";if(selected||chromeSelected||specSepected){var localId=report.localCandidateId;var remoteId=report.remoteCandidateId;event.localCandidateChanged=!!this.lastActiveLocalCandidate&&localId!==this.lastActiveLocalCandidate.id;event.remoteCandidateChanged=!!this.lastActiveRemoteCandidate&&remoteId!==this.lastActiveRemoteCandidate.id;if(!this.lastActiveLocalCandidate||event.localCandidateChanged||event.remoteCandidateChanged){results.forEach(function(result){_this2._checkLastActiveCandidate({localId:localId,remoteId:remoteId,key:result.key,report:result.value})})}if(this.lastActiveLocalCandidate){event.networkType=this.lastActiveLocalCandidate.networkType;if(this.lastActiveRemoteCandidate){event.candidatePair=this.lastActiveLocalCandidate.candidateType+";"+this.lastActiveRemoteCandidate.candidateType}}}return}var local=!!report.bytesSent;var lastResultReport=void 0;if(!this.lastResult){return}lastResultReport=this.lastResult.find&&this.lastResult.find(function(r){return r.key===key});lastResultReport=lastResultReport&&lastResultReport.value;if(!lastResultReport||lastResultReport.timestamp>=now){return}if(!kind){this.connection.getLocalStreams()[0].getTracks().forEach(function(track){if(track.id===report.googTrackId){kind=track.kind}})}var muted=false;if(!kind){muted=true;if(report.googCodecName){var codec=report.googCodecName.toLowerCase();if(codec==="vp8"){kind="video"}else if(codec==="opus"){kind="audio"}}}var bytes=parseInt(local?report.bytesSent:report.bytesReceived,10)||0;var previousBytesTotal=parseInt(local?lastResultReport.bytesSent:lastResultReport.bytesReceived,10)||0;var deltaTime=now-new Date(lastResultReport.timestamp);var bitrate=Math.floor(8*(bytes-previousBytesTotal)/deltaTime);var bytesSent=parseInt(report.bytesSent,10)||-1;var bytesReceived=parseInt(report.bytesReceived,10)||-1;var rtt=parseInt(report.googRtt||report.mozRtt||report.roundTripTime,10)||-1;if(rtt!==-1){event[kind+"Rtt"]=rtt}var jitter=parseInt(report.googJitterReceived||report.mozJitterReceived||report.jitter,10)||-1;if(jitter!==-1){event[kind+"Jitter"]=jitter}var lost=0;var previousLost=0;var total=0;var previousTotal=0;var remoteItem=void 0;remoteItem=results.find(function(r){return r.key===report.remoteId});if(report.remoteId&&remoteItem){lost=remoteItem.packetsLost;previousLost=lastResultReport.packetsLost;if(lost<previousLost){this.logger.warn("Possible stats bug: current lost should not be less than previousLost. Overriding current lost with previousLost.",{lost:lost,previousLost:previousLost});lost=previousLost;remoteItem.packetsLost=lost}}else if(report.packetsLost||report.packetsSent||report.packetsReceived){if(report.packetsLost){lost=parseInt(report.packetsLost,10)||0;previousLost=parseInt(lastResultReport.packetsLost,10)||0;if(lost<previousLost){this.logger.warn("Possible stats bug: current lost should not be less than previousLost. Overriding current lost with previousLost.",{lost:lost,previousLost:previousLost});lost=previousLost;report.packetsLost=""+lost}}if(local&&report.packetsSent){total=parseInt(report.packetsSent,10)||0;previousTotal=parseInt(lastResultReport.packetsSent,10)||0}if(!local&&report.packetsReceived){total=parseInt(report.packetsReceived,10)||0;previousTotal=parseInt(lastResultReport.packetsReceived,10)||0}}var loss=0;if(total>0){loss=Math.floor(lost/total*100)}var intervalLoss=Math.floor((lost-previousLost)/(total-previousTotal)*100)||0;var trackInfo={track:track,kind:kind,bitrate:bitrate,lost:lost,muted:muted,loss:loss,intervalLoss:intervalLoss,bytesSent:bytesSent,bytesReceived:bytesReceived};if(kind==="audio"){trackInfo.aecDivergentFilterFraction=parseInt(report.aecDivergentFilterFraction,10)||0;trackInfo.googEchoCanellationEchoDelayMedian=parseInt(report.googEchoCanellationEchoDelayMedian,10)||0;trackInfo.googEchoCancellationEchoDelayStdDev=parseInt(report.googEchoCancellationEchoDelayStdDev,10)||0;trackInfo.googEchoCancellationReturnLoss=parseInt(report.googEchoCancellationReturnLoss,10)||0;trackInfo.googEchoCancellationReturnLossEnhancement=parseInt(report.googEchoCancellationReturnLossEnhancement,10)||0}if(kind==="audio"&&report.audioInputLevel){trackInfo.audioInputLevel=parseInt(report.audioInputLevel,10)||0}if(local){event.tracks.push(trackInfo)}else{event.remoteTracks.push(trackInfo)}}},{key:"_createStatsReport",value:function _createStatsReport(results,updateLastResult){var _this3=this;var event={name:"getStats",session:this.session,initiator:this.initiator,conference:this.conference,tracks:[],remoteTracks:[]};results=this._polyFillStats(results);results.forEach(function(result){_this3._processReport({key:result.key,report:result.value,results:results,event:event})});if(updateLastResult){this.lastResult=results}return event}},{key:"collectTraces",value:function collectTraces(){var _this4=this;this.connection.on("PeerConnectionTrace",function(data){_this4.traceData.push(data)});this.connection.on("error",function(){_this4.emit("traces",{name:"trace",session:_this4.session,initiator:_this4.initiator,conference:_this4.conference,traces:_this4.traceData})})}},{key:"collectStats",value:function collectStats(){var _this5=this;this.connection.on("iceConnectionStateChange",function(){var state=_this5.connection.iceConnectionState;if(state==="connected"||state==="completed"){if(_this5._pollingInterval!==null){return}var statsPoll=function statsPoll(){_this5._gatherStats().then(function(reports){var event=_this5._createStatsReport(reports,true);if(event.tracks.length>0||event.remoteTracks.length>0){_this5.emit("stats",event)}})};if(IS_BROWSER){window.setTimeout(statsPoll,0);_this5._pollingInterval=window.setInterval(statsPoll,_this5.statsInterval)}}if(state==="disconnected"){if(_this5.connection.signalingState!=="stable"){return}_this5._gatherStats().then(function(reports){var event=_this5._createStatsReport(reports);event.type="iceDisconnected";_this5.emit("stats",event)})}if(state==="closed"){if(_this5._pollingInterval){if(IS_BROWSER){window.clearInterval(_this5._pollingInterval)}_this5._pollingInterval=null}}})}},{key:"collectInitialConnectionStats",value:function collectInitialConnectionStats(){var _this6=this;this.connection.on("iceConnectionStateChange",function(){var state=_this6.connection.iceConnectionState;if(state==="checking"){if(IS_BROWSER){_this6._iceStartTime=window.performance.now()}}if(state==="connected"||state==="completed"){if(_this6._haveConnectionMetrics){return}_this6._haveConnectionMetrics=true;var userAgent=void 0,platform=void 0,cores=void 0;if(IS_BROWSER){_this6._iceConnectionTime=window.performance.now()-_this6._iceStartTime;userAgent=window.navigator.userAgent;platform=window.navigator.platform;cores=window.navigator.hardwareConcurrency}_this6._gatherStats().then(function(reports){var event={name:"connect",userAgent:userAgent,platform:platform,cores:cores,session:_this6.session,initiator:_this6.initiator,conference:_this6.conference,connectTime:_this6._iceConnectionTime,hadLocalIPv6Candidate:_this6.connection.hadLocalIPv6Candidate,hadRemoteIPv6Candidate:_this6.connection.hadRemoteIPv6Candidate,hadLocalRelayCandidate:_this6.connection.hadLocalRelayCandidate,hadRemoteRelayCandidate:_this6.connection.hadremoteRelayCandidate};var activeCandidatePair=null;var activeCandidatePairId=void 0;reports.forEach(function(_ref3){var key=_ref3.key,value=_ref3.value;var report=value;var selected=report.type==="candidatepair"&&report.selected;var specSepected=report.type==="candidate-pair"&&report.nominated&&report.state==="succeeded";var chromeSelected=report.type==="googCandidatePair"&&report.googActiveConnection==="true";if(selected||chromeSelected||specSepected){activeCandidatePair=report}if(report.selectedCandidatePairId){activeCandidatePairId=report.selectedCandidatePairId}event.dtlsCipher=event.dtlsCipher||report.dtlsCipher;event.srtpCipher=event.srtpCipher||report.srtpCipher});if(!activeCandidatePair&&activeCandidatePairId){
var report=reports.find(function(r){return r.value.id===activeCandidatePairId});if(report){activeCandidatePair=report.value}}if(activeCandidatePair){var localId=activeCandidatePair.localCandidateId;var remoteId=activeCandidatePair.remoteCandidateId;var localCandidate=void 0,remoteCandidate=void 0;reports.forEach(function(_ref4){var key=_ref4.key,value=_ref4.value;var report=value;if(localId&&(report.type==="localcandidate"||report.type==="local-candidate")&&report.id===localId){localCandidate=report;event.localCandidateType=report.candidateType}if(remoteId&&(report.type==="remotecandidate"||report.type==="remote-candidate")&&report.id===remoteId){remoteCandidate=report;event.remoteCandidateType=report.candidateType}});if(localCandidate&&remoteCandidate){event.candidatePair=localCandidate.candidateType+";"+remoteCandidate.candidateType;event.candidatePairDetails={local:localCandidate,remote:remoteCandidate}}if(localCandidate){event.transport=localCandidate.transport||localCandidate.protocol;if(localCandidate.priority){var turnTypes={2:"udp",1:"tcp",0:"tls"};var priority=parseInt(localCandidate.priority,10);event.turnType=turnTypes[priority>>24];event.networkType=localCandidate.networkType}event.usingIPv6=localCandidate.ipAddress&&localCandidate.ipAddress.indexOf("[")===0}}_this6.emit("stats",event)})}if(state==="failed"){if(IS_BROWSER){_this6._iceFailedTime=window.performance.now()-_this6._iceStartTime}_this6._gatherStats().then(function(reports){var event={name:"failure",session:_this6.session,initiator:_this6.initiator,conference:_this6.conference,failTime:_this6._iceFailureTime,iceRW:0,numLocalHostCandidates:0,numLocalSrflxCandidates:0,numLocalRelayCandidates:0,numRemoteHostCandidates:0,numRemoteSrflxCandidates:0,numRemoteRelayCandidates:0};reports.forEach(function(_ref5){var key=_ref5.key,value=_ref5.value;var report=value;if(report.type==="googCandidatePair"){if(report.googWritable==="true"&&report.googReadable==="true"){event.iceRW++}}});var localCandidates=_this6.connection.pc.localDescription.sdp.split("\r\n").filter(function(line){return line.indexOf("a=candidate:")>-1});var remoteCandidates=_this6.connection.pc.remoteDescription.sdp.split("\r\n").filter(function(line){return line.indexOf("a=candidate:")>-1});["Host","Srflx","Relay"].forEach(function(type){event["numLocal"+type+"Candidates"]=localCandidates.filter(function(line){return line.split(" ")[7]===type.toLowerCase()}).length;event["numRemote"+type+"Candidates"]=remoteCandidates.filter(function(line){return line.split(" ")[7]===type.toLowerCase()}).length});_this6.emit("stats",event);_this6.emit("traces",{name:"trace",session:_this6.session,initiator:_this6.initiator,conference:_this6.conference,traces:_this6.traceData})})}})}}]);return StatsGatherer}(_events.EventEmitter);exports.default=StatsGatherer},{events:1}],18:[function(require,module,exports){module.exports=WildEmitter;function WildEmitter(){}WildEmitter.mixin=function(constructor){var prototype=constructor.prototype||constructor;prototype.isWildEmitter=true;prototype.on=function(event,groupName,fn){this.callbacks=this.callbacks||{};var hasGroup=arguments.length===3,group=hasGroup?arguments[1]:undefined,func=hasGroup?arguments[2]:arguments[1];func._groupName=group;(this.callbacks[event]=this.callbacks[event]||[]).push(func);return this};prototype.once=function(event,groupName,fn){var self=this,hasGroup=arguments.length===3,group=hasGroup?arguments[1]:undefined,func=hasGroup?arguments[2]:arguments[1];function on(){self.off(event,on);func.apply(this,arguments)}this.on(event,group,on);return this};prototype.releaseGroup=function(groupName){this.callbacks=this.callbacks||{};var item,i,len,handlers;for(item in this.callbacks){handlers=this.callbacks[item];for(i=0,len=handlers.length;i<len;i++){if(handlers[i]._groupName===groupName){handlers.splice(i,1);i--;len--}}}return this};prototype.off=function(event,fn){this.callbacks=this.callbacks||{};var callbacks=this.callbacks[event],i;if(!callbacks)return this;if(arguments.length===1){delete this.callbacks[event];return this}i=callbacks.indexOf(fn);callbacks.splice(i,1);if(callbacks.length===0){delete this.callbacks[event]}return this};prototype.emit=function(event){this.callbacks=this.callbacks||{};var args=[].slice.call(arguments,1),callbacks=this.callbacks[event],specialCallbacks=this.getWildcardCallbacks(event),i,len,item,listeners;if(callbacks){listeners=callbacks.slice();for(i=0,len=listeners.length;i<len;++i){if(!listeners[i]){break}listeners[i].apply(this,args)}}if(specialCallbacks){len=specialCallbacks.length;listeners=specialCallbacks.slice();for(i=0,len=listeners.length;i<len;++i){if(!listeners[i]){break}listeners[i].apply(this,[event].concat(args))}}return this};prototype.getWildcardCallbacks=function(eventName){this.callbacks=this.callbacks||{};var item,split,result=[];for(item in this.callbacks){split=item.split("*");if(item==="*"||split.length===2&&eventName.slice(0,split[0].length)===split[0]){result=result.concat(this.callbacks[item])}}return result}};WildEmitter.mixin(WildEmitter)},{}],19:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.SymmetricNatTest=exports.AudioBandwidthTest=exports.VideoBandwidthTest=exports.ThroughputTest=exports.AdvancedCameraTest=exports.ConnectivityTest=exports.VideoTest=exports.AudioTest=undefined;var _AudioTest=require("./diagnostics/AudioTest");var _AudioTest2=_interopRequireDefault(_AudioTest);var _VideoTest=require("./diagnostics/VideoTest");var _VideoTest2=_interopRequireDefault(_VideoTest);var _ConnectivityTest=require("./diagnostics/ConnectivityTest");var _ConnectivityTest2=_interopRequireDefault(_ConnectivityTest);var _AdvancedCameraTest=require("./diagnostics/AdvancedCameraTest");var _AdvancedCameraTest2=_interopRequireDefault(_AdvancedCameraTest);var _DataThroughputTest=require("./diagnostics/DataThroughputTest");var _DataThroughputTest2=_interopRequireDefault(_DataThroughputTest);var _VideoBandwidthTest=require("./diagnostics/VideoBandwidthTest");var _VideoBandwidthTest2=_interopRequireDefault(_VideoBandwidthTest);var _AudioBandwidthTest=require("./diagnostics/AudioBandwidthTest");var _AudioBandwidthTest2=_interopRequireDefault(_AudioBandwidthTest);var _SymmetricNatTest=require("./diagnostics/SymmetricNatTest");var _SymmetricNatTest2=_interopRequireDefault(_SymmetricNatTest);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}exports.AudioTest=_AudioTest2.default;exports.VideoTest=_VideoTest2.default;exports.ConnectivityTest=_ConnectivityTest2.default;exports.AdvancedCameraTest=_AdvancedCameraTest2.default;exports.ThroughputTest=_DataThroughputTest2.default;exports.VideoBandwidthTest=_VideoBandwidthTest2.default;exports.AudioBandwidthTest=_AudioBandwidthTest2.default;exports.SymmetricNatTest=_SymmetricNatTest2.default},{"./diagnostics/AdvancedCameraTest":20,"./diagnostics/AudioBandwidthTest":21,"./diagnostics/AudioTest":22,"./diagnostics/ConnectivityTest":24,"./diagnostics/DataThroughputTest":25,"./diagnostics/SymmetricNatTest":26,"./diagnostics/VideoBandwidthTest":27,"./diagnostics/VideoTest":28}],20:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};var _TestSuite2=require("../utils/TestSuite");var _TestSuite3=_interopRequireDefault(_TestSuite2);var _CameraResolutionTest=require("./CameraResolutionTest");var _CameraResolutionTest2=_interopRequireDefault(_CameraResolutionTest);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var AdvancedCameraTest=function(_TestSuite){_inherits(AdvancedCameraTest,_TestSuite);function AdvancedCameraTest(options){_classCallCheck(this,AdvancedCameraTest);var _this=_possibleConstructorReturn(this,(AdvancedCameraTest.__proto__||Object.getPrototypeOf(AdvancedCameraTest)).apply(this,arguments));_this.name="Advanced Video Test";_this.tests=[];_this.promise=new Promise(function(resolve,reject){_this.deferred={resolve:resolve,reject:reject}});_this.stopOnFailure=true;_this.addTest(new _CameraResolutionTest2.default([[320,240]],options));_this.addTest(new _CameraResolutionTest2.default([[640,480]],options));_this.addTest(new _CameraResolutionTest2.default([[1280,720]],options));_this.addTest(new _CameraResolutionTest2.default([[160,120],[320,180],[320,240],[640,360],[640,480],[768,576],[1024,576],[1280,720],[1280,768],[1280,800],[1920,1080],[1920,1200],[3840,2160],[4096,2160]],options));return _this}_createClass(AdvancedCameraTest,[{key:"start",value:function start(){var _this2=this;_get(AdvancedCameraTest.prototype.__proto__||Object.getPrototypeOf(AdvancedCameraTest.prototype),"start",this).call(this).then(function(results){return _this2.deferred.resolve(results)},function(err){return _this2.deferred.reject(err)});return this.promise}},{key:"destroy",value:function destroy(){_get(AdvancedCameraTest.prototype.__proto__||Object.getPrototypeOf(AdvancedCameraTest.prototype),"stopAllTests",this).call(this)}}]);return AdvancedCameraTest}(_TestSuite3.default);exports.default=AdvancedCameraTest},{"../utils/TestSuite":33,"./CameraResolutionTest":23}],21:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};var _WebrtcCall=require("../utils/WebrtcCall");var _WebrtcCall2=_interopRequireDefault(_WebrtcCall);var _Test2=require("../utils/Test");var _Test3=_interopRequireDefault(_Test2);var _StatisticsAggregate=require("../utils/StatisticsAggregate");var _StatisticsAggregate2=_interopRequireDefault(_StatisticsAggregate);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var AudioBandwidthTest=function(_Test){_inherits(AudioBandwidthTest,_Test);function AudioBandwidthTest(){_classCallCheck(this,AudioBandwidthTest);var _this=_possibleConstructorReturn(this,(AudioBandwidthTest.__proto__||Object.getPrototypeOf(AudioBandwidthTest)).apply(this,arguments));_this.name="Audio Bandwidth Test";_this.maxAudioBitrateKbps=510;_this.durationMs=4e4;_this.statStepMs=100;_this.bweStats=new _StatisticsAggregate2.default(.75*_this.maxAudioBitrateKbps*1e3);_this.rttStats=new _StatisticsAggregate2.default;_this.packetsLost=null;_this.startTime=null;_this.call=null;_this.constraints={video:false};if(_this.options.mediaOptions.audio.deviceId){_this.constraints.audio={deviceId:_this.options.mediaOptions.audio.deviceId}}else{_this.constraints.audio=true}_this.log=[];_this.stats={};return _this}_createClass(AudioBandwidthTest,[{key:"start",value:function start(){var _this2=this;_get(AudioBandwidthTest.prototype.__proto__||Object.getPrototypeOf(AudioBandwidthTest.prototype),"start",this).call(this);if(!this.options.iceConfig.iceServers.length){var error=new Error("No ice servers were provided");error.details=this.log;return this.reject(error)}this.call=new _WebrtcCall2.default(this.options.iceConfig,this.logger);this.call.setIceCandidateFilter(_WebrtcCall2.default.isRelay);return this.doGetUserMedia(this.constraints).then(function(stream){return _this2.setupCall(stream)}).then(this.runTest.bind(this)).then(this.completed.bind(this)).then(function(){if(_this2.hasError){return Promise.reject(new Error("Audio Bandwidth Error"))}return _this2.resolve(_this2.getResults())}).catch(function(err){var results=_this2.getResults();results.error=err;return _this2.reject(err)})}},{key:"getResults",value:function getResults(){return{log:this.log,stats:this.stats,constraints:this.constraints}}},{key:"addLog",value:function addLog(level,msg){this.logger[level.toLowerCase()](msg);if(msg&&(typeof msg==="undefined"?"undefined":_typeof(msg))==="object"){msg=JSON.stringify(msg)}if(level==="error"){this.hasError=true}this.log.push(level+": "+msg)}},{key:"doGetUserMedia",value:function doGetUserMedia(constraints){var _this3=this;this.addLog("info",{status:"pending",constraints:constraints});return navigator.mediaDevices.getUserMedia(constraints).then(function(stream){var audioTrack=_this3.getDeviceName(stream.getAudioTracks());_this3.addLog("info",{status:"success",audioTrack:audioTrack});return stream}).catch(function(error){_this3.addLog("error",{status:"fail",error:error});_this3.addLog("error","Failed to get access to local media due to error: "+error.name);return _this3.reject(error)})}},{key:"getDeviceName",value:function getDeviceName(tracks){if(tracks.length===0){return null}return tracks[0].label}},{key:"setupCall",value:function setupCall(stream){var _this4=this;stream.getTracks().forEach(function(t){return _this4.call.pc1.pc.addTrack(t,stream)});return this.call.establishConnection().then(function(){_this4.addLog("info",{status:"success",message:"establishing connection"});_this4.startTime=new Date;_this4.localTrack=stream.getAudioTracks()[0]},function(error){_this4.addLog("warn",{status:"error",error:error});return Promise.reject(error)})}},{key:"runTest",value:function runTest(){var _this5=this;return new Promise(function(resolve,reject){_this5.nextTimeout=setTimeout(function(){_this5.gatherStats().then(resolve,reject)},_this5.statStepMs)})}},{key:"gatherStats",value:function gatherStats(){var _this6=this;var now=new Date;if(now-this.startTime>this.durationMs){return Promise.resolve()}return this.call.pc1.getStats(this.localTrack).then(this.gotStats.bind(this)).catch(function(error){return _this6.addLog("error","Failed to getStats: "+error)})}},{key:"gotStats",value:function gotStats(response){var _this7=this;if(!response){this.addLog("error","Got no response from stats... odd...")}else{var results=typeof response.result==="function"?response.result():response;results.forEach(function(report){if(report.availableOutgoingBitrate){var value=parseInt(report.availableOutgoingBitrate,10);_this7.bweStats.add(new Date(report.timestamp),value)}if(report.totalRoundTripTime||report.roundTripTime){var _value=parseInt(report.totalRoundTripTime||report.roundTripTime,10);_this7.rttStats.add(new Date(report.timestamp),_value)}if(report.packetsSent){_this7.packetsSent=report.packetsSent}if(report.packetsLost){_this7.packetsLost=report.packetsLost}if(report.frameWidth){_this7.videoStats[0]=report.frameWidth}if(report.frameHeight){_this7.videoStats[1]=report.frameHeight}})}return this.runTest()}},{key:"completed",value:function completed(){var stats=this.stats;stats.mbpsAvg=this.bweStats.getAverage()/(1e3*1e3);stats.mbpsMax=this.bweStats.getMax()/(1e3*1e3);this.addLog("info","Send bandwidth estimate average: "+stats.mbpsAvg+" mpbs");this.addLog("info","Send bandwidth estimate max: "+stats.mbpsMax+" mbps");stats.rttAverage=this.rttStats.getAverage();stats.rttMax=this.rttStats.getMax();stats.packetsSent=parseInt(this.packetsSent);if(this.packetsSent){stats.packetLoss=parseInt(this.packetsLost||0,10)/parseFloat(this.packetsSent)}this.addLog("info","RTT average: "+stats.rttAverage+" ms");this.addLog("info","RTT max: "+stats.rttMax+" ms");this.addLog("info","Packets sent: "+stats.rttMax+" ms");this.addLog("info","Packet loss %: "+stats.packetLoss);return this.results}},{key:"destroy",value:function destroy(){_get(AudioBandwidthTest.prototype.__proto__||Object.getPrototypeOf(AudioBandwidthTest.prototype),"destroy",this).call(this);window.clearTimeout(this.nextTimeout);if(this.call){var pc=this.call.pc1;if(pc.getSenders){pc.getSenders().forEach(function(sender){return sender.track.stop()})}if(pc.getTransceivers){pc.getTransceivers().forEach(function(t){return t.stop()})}this.call.close();this.call=null}}}]);return AudioBandwidthTest}(_Test3.default);exports.default=AudioBandwidthTest},{"../utils/StatisticsAggregate":31,"../utils/Test":32,"../utils/WebrtcCall":35}],22:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};var _Test2=require("../utils/Test");var _Test3=_interopRequireDefault(_Test2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var LocalMedia=require("localmedia");var MIC_DETECTION_THRESHOLD=-100;var AudioTest=function(_Test){_inherits(AudioTest,_Test);function AudioTest(){_classCallCheck(this,AudioTest);var _this=_possibleConstructorReturn(this,(AudioTest.__proto__||Object.getPrototypeOf(AudioTest)).apply(this,arguments));_this.name="Audio Test";_this.volumeTimeout=_this.options.volumeTimeout||5e3;_this.localMedia=new LocalMedia({detectSpeakingEvents:true});return _this}_createClass(AudioTest,[{key:"start",value:function start(){var _this2=this;_get(AudioTest.prototype.__proto__||Object.getPrototypeOf(AudioTest.prototype),"start",this).call(this);var volumeCheckFailure=window.setTimeout(function(){_this2.logger.error("No change in mic volume");_this2.reject(new Error("audio timeout"))},this.volumeTimeout);this.localMedia.start(this.options,function(err){if(err){_this2.logger.error("Audio Local media start failed");_this2.reject(err)}else{_this2.logger.log("Audio Local media started")}});this.localMedia.on("volumeChange",function(volume){if(volume>MIC_DETECTION_THRESHOLD){window.clearTimeout(volumeCheckFailure);_this2.resolve()}});this.localMedia.on("localStream",function(stream){if(stream.getAudioTracks().length){var audioTrack=stream.getAudioTracks()[0];if(audioTrack){_this2.logger.log("Audio stream passed")}else{_this2.logger.error("Audio stream failed");_this2.reject(new Error("no audio tracks available"))}}});return this.promise}},{key:"destroy",value:function destroy(){_get(AudioTest.prototype.__proto__||Object.getPrototypeOf(AudioTest.prototype),"destroy",this).call(this);this.localMedia.stop()}}]);return AudioTest}(_Test3.default);exports.default=AudioTest},{"../utils/Test":32,localmedia:4}],23:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};var _VideoFrameChecker=require("../utils/VideoFrameChecker");var _VideoFrameChecker2=_interopRequireDefault(_VideoFrameChecker);var _WebrtcCall=require("../utils/WebrtcCall");var _WebrtcCall2=_interopRequireDefault(_WebrtcCall);var _Test2=require("../utils/Test");var _Test3=_interopRequireDefault(_Test2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var CameraResolutionTest=function(_Test){_inherits(CameraResolutionTest,_Test);function CameraResolutionTest(resolutions,options){_classCallCheck(this,CameraResolutionTest);var _this=_possibleConstructorReturn(this,(CameraResolutionTest.__proto__||Object.getPrototypeOf(CameraResolutionTest)).call(this,options));_this.name="Camera resolution test "+JSON.stringify(resolutions);_this.resolutions=resolutions;_this.duration=options.duration;_this.logger=options&&options.logger?options.logger:console;_this.log=[];_this.currentResolution=0;_this.isMuted=false;_this.isShuttingDown=false;return _this}_createClass(CameraResolutionTest,[{key:"start",value:function start(){var _this2=this;_get(CameraResolutionTest.prototype.__proto__||Object.getPrototypeOf(CameraResolutionTest.prototype),"start",this).call(this);var settings={resolutions:this.resolutions,duration:this.duration};this.logger.log("Advanced Camera Test with resolutions: "+JSON.stringify(settings.resolutions)+" and duration "+JSON.stringify(settings.duration));return this.startGetUserMedia(this.resolutions[this.currentResolution]).then(function(){if(!_this2.hasError){return _this2.resolve(_this2.getResults())}else{var err=new Error("Camera resolution check failed");err.details=_this2.getResults();return _this2.reject(err)}},function(err){err.details=_this2.getResults();return _this2.reject(err)})}},{key:"getResults",value:function getResults(){var results={log:this.log,stats:this.stats,resolutions:this.resolutions,duration:this.duration};return results}},{key:"reportSuccess",value:function reportSuccess(str){this.log.push(str);this.logger.log("SUCCESS: "+str)}},{key:"reportError",value:function reportError(str){this.hasError=true;this.log.push(str);this.logger.warn(""+str)}},{key:"reportInfo",value:function reportInfo(str){this.logger.info(""+str)}},{key:"startGetUserMedia",value:function startGetUserMedia(resolution){var _this3=this;var constraints={audio:false,video:{width:{exact:resolution[0]},height:{exact:resolution[1]}}};return navigator.mediaDevices.getUserMedia(constraints).then(function(stream){if(_this3.resolutions.length>1){_this3.reportSuccess("Supported: "+resolution[0]+"x"+resolution[1]);stream.getTracks().forEach(function(track){track.stop()});return _this3.maybeContinueGetUserMedia()}else{_this3.logger.log("collecting");return _this3.collectAndAnalyzeStats(stream,resolution)}},function(error){if(_this3.resolutions.length>1){_this3.reportInfo(resolution[0]+"x"+resolution[1]+" not supported")}else{_this3.reportError("getUserMedia failed with error: "+error)}return _this3.maybeContinueGetUserMedia()})}},{key:"maybeContinueGetUserMedia",value:function maybeContinueGetUserMedia(){var _this4=this;if(this.currentResolution===this.resolutions.length){return this.getResults()}return new Promise(function(resolve,reject){setTimeout(function(){_this4.startGetUserMedia(_this4.resolutions[_this4.currentResolution++]).then(resolve,reject)},1e3)})}},{key:"collectAndAnalyzeStats",value:function collectAndAnalyzeStats(stream,resolution){var _this5=this;var tracks=stream.getVideoTracks();if(tracks.length<1){this.reportError("No video track in returned stream.");return this.maybeContinueGetUserMedia()}var videoTrack=tracks[0];if(typeof videoTrack.addEventListener==="function"){videoTrack.addEventListener("ended",function(){if(_this5.isShuttingDown){return}_this5.reportError("Video track ended, camera stopped working")});videoTrack.addEventListener("mute",function(){if(_this5.isShuttingDown){return}_this5.reportError("Your camera reported itself as muted.");_this5.isMuted=true});videoTrack.addEventListener("unmute",function(){if(_this5.isShuttingDown){return}_this5.reportInfo("Your camera reported itself as unmuted.");_this5.isMuted=false})}var videoElement=document.createElement("video");videoElement.setAttribute("autoplay","");videoElement.setAttribute("muted","");videoElement.width=resolution[0];videoElement.height=resolution[1];videoElement.srcObject=stream;var frameChecker=new _VideoFrameChecker2.default(videoElement);var call=new _WebrtcCall2.default(undefined,this.logger);stream.getTracks().forEach(function(t){return call.pc1.pc.addTrack(t,stream)});setTimeout(this.endCall.bind(this,call,stream),8e3);return call.establishConnection().then(function(){return call.gatherStats(call.pc1,100)},function(err){return Promise.reject(err)}).then(function(_ref){var stats=_ref.stats,statsCollectTime=_ref.statsCollectTime;var result=_this5.analyzeStats({resolution:resolution,videoElement:videoElement,stream:stream,frameChecker:frameChecker,stats:stats,statsCollectTime:statsCollectTime});frameChecker.stop();return result},function(err){return Promise.reject(err)})}},{key:"analyzeStats",value:function analyzeStats(_ref2){var resolution=_ref2.resolution,videoElement=_ref2.videoElement,stream=_ref2.stream,frameChecker=_ref2.frameChecker,stats=_ref2.stats,statsCollectTime=_ref2.statsCollectTime;this.stats=stats;var googAvgEncodeTime=[];var googAvgFrameRateInput=[];var googAvgFrameRateSent=[];var statsReport={};var frameStats=frameChecker.frameStats;stats.forEach(function(stat){if(stat.type==="ssrc"){if(parseInt(stat.googFrameRateInput,10)>0){googAvgEncodeTime.push(parseInt(stat.googAvgEncodeMs,10));googAvgFrameRateInput.push(parseInt(stat.googFrameRateInput,10));googAvgFrameRateSent.push(parseInt(stat.googFrameRateSent,10))}}});statsReport.cameraName=stream.getVideoTracks()[0].label||NaN;statsReport.actualVideoWidth=videoElement.videoWidth;statsReport.actualVideoHeight=videoElement.videoHeight;statsReport.mandatoryWidth=resolution[0];statsReport.mandatoryHeight=resolution[1];statsReport.encodeSetupTimeMs=this.extractEncoderSetupTime(stats,statsCollectTime);statsReport.avgEncodeTimeMs=this.arrayAverage(googAvgEncodeTime);statsReport.minEncodeTimeMs=Math.min.apply(Math,googAvgEncodeTime);statsReport.maxEncodeTimeMs=Math.max.apply(Math,googAvgEncodeTime);statsReport.avgInputFps=this.arrayAverage(googAvgFrameRateInput);statsReport.minInputFps=Math.min.apply(Math,googAvgFrameRateInput);statsReport.maxInputFps=Math.max.apply(Math,googAvgFrameRateInput);statsReport.avgSentFps=this.arrayAverage(googAvgFrameRateSent);statsReport.minSentFps=Math.min.apply(Math,googAvgFrameRateSent);statsReport.maxSentFps=Math.max.apply(Math,googAvgFrameRateSent);statsReport.isMuted=this.isMuted;statsReport.testedFrames=frameStats.numFrames;statsReport.blackFrames=frameStats.numBlackFrames;statsReport.frozenFrames=frameStats.numFrozenFrames;this.testExpectations(statsReport);return statsReport}},{key:"endCall",value:function endCall(callObject,stream){this.isShuttingDown=true;stream.getTracks().forEach(function(track){track.stop()});callObject.close()}},{key:"extractEncoderSetupTime",
value:function extractEncoderSetupTime(stats,statsCollectTime){var res=NaN;var index=0;stats.forEach(function(stat){if(stat.type==="ssrc"&&parseInt(stat.googFrameRateInput,10)>0){res=JSON.stringify(statsCollectTime[index]-statsCollectTime[0])}index++});return res}},{key:"resolutionMatchesIndependentOfRotationOrCrop",value:function resolutionMatchesIndependentOfRotationOrCrop(aWidth,aHeight,bWidth,bHeight){var minRes=Math.min(bWidth,bHeight);return aWidth===bWidth&&aHeight===bHeight||aWidth===bHeight&&aHeight===bWidth||aWidth===minRes&&bHeight===minRes}},{key:"testExpectations",value:function testExpectations(report){var notAvailableStats=[];for(var key in report){if(typeof report[key]==="number"&&isNaN(report[key])){notAvailableStats.push(key)}}if(notAvailableStats.length!==0){report.notAvailableStatus=notAvailableStats;this.reportInfo("Not available: "+notAvailableStats.join(", "))}if(isNaN(report.avgSentFps)){this.reportInfo("Cannot verify sent FPS.")}else if(report.avgSentFps<5){this.reportError("Low average sent FPS: "+report.avgSentFps)}else{this.reportSuccess("Average FPS above threshold")}if(!this.resolutionMatchesIndependentOfRotationOrCrop(report.actualVideoWidth,report.actualVideoHeight,report.mandatoryWidth,report.mandatoryHeight)){this.reportError("Incorrect captured resolution. Expected "+report.mandatoryWidth+" by "+report.mandatoryHeight+" but got "+report.actualVideoWidth+" by "+report.actualVideoHeight)}else{this.reportSuccess("Captured video using expected resolution.")}if(report.testedFrames===0){this.reportError("Could not analyze any video frame.")}else{if(report.blackFrames>report.testedFrames/3){this.reportError("Camera delivering lots of black frames.")}if(report.frozenFrames>report.testedFrames/3){this.reportError("Camera delivering lots of frozen frames.")}}}},{key:"arrayAverage",value:function arrayAverage(array){var cnt=array.length;var tot=0;for(var i=0;i<cnt;i++){tot+=array[i]}return Math.floor(tot/cnt)}}]);return CameraResolutionTest}(_Test3.default);exports.default=CameraResolutionTest},{"../utils/Test":32,"../utils/VideoFrameChecker":34,"../utils/WebrtcCall":35}],24:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};var _Test2=require("../utils/Test");var _Test3=_interopRequireDefault(_Test2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var PeerConnection=require("rtcpeerconnection");var ConnectivityTest=function(_Test){_inherits(ConnectivityTest,_Test);function ConnectivityTest(){_classCallCheck(this,ConnectivityTest);var _this=_possibleConstructorReturn(this,(ConnectivityTest.__proto__||Object.getPrototypeOf(ConnectivityTest)).apply(this,arguments));_this.name="Connectivity Test";return _this}_createClass(ConnectivityTest,[{key:"logIceServers",value:function logIceServers(){var _this2=this;if(this.options.iceServers){this.options.iceServers.forEach(function(iceServer){_this2.logger.log("Using ICE Server: "+iceServer.url)});if(this.options.iceServers.length===0){this.logger.error("no ice servers provided")}}else{this.logger.log("Using default ICE Servers")}}},{key:"start",value:function start(){var _this3=this;_get(ConnectivityTest.prototype.__proto__||Object.getPrototypeOf(ConnectivityTest.prototype),"start",this).call(this);this.pc1=new PeerConnection(this.options);this.pc2=new PeerConnection(this.options);var connectivityCheckFailure=window.setTimeout(function(){_this3.logger.error("Connectivity timeout error");_this3.reject(new Error("connectivity timeout"))},1e4);this.pc2.on("ice",function(candidate){_this3.logger.log("pc2 ICE candidate",candidate);_this3.pc1.processIce(candidate)});this.pc1.on("ice",function(candidate){_this3.logger.log("pc1 ICE candidate",candidate);_this3.pc2.processIce(candidate)});this.pc2.on("answer",function(answer){_this3.logger.log("pc2 handle answer");_this3.pc1.handleAnswer(answer)});this.pc1.on("offer",function(offer){_this3.logger.log("pc1 offer");_this3.pc2.handleOffer(offer,function(err){if(err){_this3.logger.error("pc2 failed to handle offer");_this3.reject(err)}_this3.logger.log("pc2 handle offer");_this3.pc2.answer(function(err,answer){if(err){_this3.logger.error("pc2 failed answer");_this3.reject(err)}_this3.logger.log("pc2 successful "+answer.type)})})});this.dataChannel=this.pc1.createDataChannel("testChannel");var messageQueue=Array.apply(null,{length:100}).map(function(n,i){return"message "+i});var messageQueue2=Array.apply(null,{length:100}).map(function(n,i){return"message "+i});var messagesReceived=0;this.dataChannel.onmessage=function(msgEvent){var message=messageQueue.find(function(message){return message===msgEvent.data});_this3.logger.debug("got a message",message);messageQueue.splice(messageQueue.indexOf(message),1);messagesReceived++;if(messageQueue.length===0){window.clearTimeout(connectivityCheckFailure);_this3.logger.log("Received "+messagesReceived+" messages");_this3.resolve()}};this.pc2.on("addChannel",function(channel){channel.onopen=function(){_this3.logger.log("Sending "+messageQueue.length+" messages");messageQueue2.forEach(channel.send.bind(channel))}});this.pc1.offer();return this.promise}},{key:"destroy",value:function destroy(){_get(ConnectivityTest.prototype.__proto__||Object.getPrototypeOf(ConnectivityTest.prototype),"destroy",this).call(this);this.pc1.close();this.pc2.close()}}]);return ConnectivityTest}(_Test3.default);exports.default=ConnectivityTest},{"../utils/Test":32,rtcpeerconnection:8}],25:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};var _WebrtcCall=require("../utils/WebrtcCall");var _WebrtcCall2=_interopRequireDefault(_WebrtcCall);var _Test2=require("../utils/Test");var _Test3=_interopRequireDefault(_Test2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var DataChannelThroughputTest=function(_Test){_inherits(DataChannelThroughputTest,_Test);function DataChannelThroughputTest(){_classCallCheck(this,DataChannelThroughputTest);var _this=_possibleConstructorReturn(this,(DataChannelThroughputTest.__proto__||Object.getPrototypeOf(DataChannelThroughputTest)).apply(this,arguments));_this.name="Data Throughput Test";_this.testDurationSeconds=5;_this.startTime=null;_this.sentPayloadBytes=0;_this.receivedPayloadBytes=0;_this.stopSending=false;var makeString=function makeString(){_this.samplePacket="";for(var i=0;i!==1024;++i){_this.samplePacket+="h"}};makeString();_this.maxNumberOfPacketsToSend=1;_this.bytesToKeepBuffered=1024*_this.maxNumberOfPacketsToSend;_this.lastBitrateMeasureTime=null;_this.lastReceivedPayloadBytes=0;_this.call=null;_this.senderChannel=null;_this.receiveChannel=null;return _this}_createClass(DataChannelThroughputTest,[{key:"start",value:function start(){_get(DataChannelThroughputTest.prototype.__proto__||Object.getPrototypeOf(DataChannelThroughputTest.prototype),"start",this).call(this);if(!this.options.iceServers.length){this.logger.error("No ice servers were provided");this.reject(new Error("No ice servers"))}else{this.call=new _WebrtcCall2.default(this.options,this.logger);this.call.setIceCandidateFilter(_WebrtcCall2.default.isRelay);this.senderChannel=this.call.pc1.createDataChannel(null);this.senderChannel.addEventListener("open",this.sendingStep.bind(this));this.call.pc2.on("addChannel",this.onReceiverChannel.bind(this));this.call.establishConnection()}return this.promise}},{key:"onReceiverChannel",value:function onReceiverChannel(channel){this.receiveChannel=channel;this.receiveChannel.addEventListener("message",this.onMessageReceived.bind(this))}},{key:"sendingStep",value:function sendingStep(){var now=new Date;if(!this.startTime){this.startTime=now;this.lastBitrateMeasureTime=now}for(var i=0;i!==this.maxNumberOfPacketsToSend;++i){if(this.senderChannel.bufferedAmount>=this.bytesToKeepBuffered){break}this.sentPayloadBytes+=this.samplePacket.length;this.senderChannel.send(this.samplePacket)}if(now-this.startTime>=1e3*this.testDurationSeconds){this.stopSending=true}else{this.throughputTimeout=setTimeout(this.sendingStep.bind(this),1)}}},{key:"onMessageReceived",value:function onMessageReceived(event){this.receivedPayloadBytes+=event.data.length;var now=new Date;if(now-this.lastBitrateMeasureTime>=1e3){var bitrate=(this.receivedPayloadBytes-this.lastReceivedPayloadBytes)/(now-this.lastBitrateMeasureTime);bitrate=Math.round(bitrate*1e3*8)/1e3;this.logger.log("Transmitting at "+bitrate+" kbps.");this.lastReceivedPayloadBytes=this.receivedPayloadBytes;this.lastBitrateMeasureTime=now}if(this.stopSending&&this.sentPayloadBytes===this.receivedPayloadBytes){this.call.close();this.call=null;var elapsedTime=Math.round((now-this.startTime)*10)/1e4;var receivedKBits=this.receivedPayloadBytes*8/1e3;this.logger.log(receivedKBits+" kb in "+elapsedTime+" seconds.");this.resolve()}}},{key:"destroy",value:function destroy(){_get(DataChannelThroughputTest.prototype.__proto__||Object.getPrototypeOf(DataChannelThroughputTest.prototype),"destroy",this).call(this);window.clearTimeout(this.throughputTimeout);if(this.call){this.call.close();this.call=null}}}]);return DataChannelThroughputTest}(_Test3.default);exports.default=DataChannelThroughputTest},{"../utils/Test":32,"../utils/WebrtcCall":35}],26:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};var _Test2=require("../utils/Test");var _Test3=_interopRequireDefault(_Test2);var _parseCandidate=require("../utils/parseCandidate");var _parseCandidate2=_interopRequireDefault(_parseCandidate);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var SymmetricNatTest=function(_Test){_inherits(SymmetricNatTest,_Test);function SymmetricNatTest(){_classCallCheck(this,SymmetricNatTest);var _this=_possibleConstructorReturn(this,(SymmetricNatTest.__proto__||Object.getPrototypeOf(SymmetricNatTest)).apply(this,arguments));_this.name="Symmetric Nat Test";return _this}_createClass(SymmetricNatTest,[{key:"start",value:function start(){var _this2=this;_get(SymmetricNatTest.prototype.__proto__||Object.getPrototypeOf(SymmetricNatTest.prototype),"start",this).call(this);var pc=new window.RTCPeerConnection({iceServers:[{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"}]});pc.createDataChannel("symmetricNatTest");var candidates={};pc.onicecandidate=function(e){if(e.candidate&&e.candidate.candidate.indexOf("srflx")!==-1){var candidate=(0,_parseCandidate2.default)(e.candidate.candidate);_this2.logger.log("SymmetricNatTest Candidate",candidate);if(!candidates[candidate.relatedPort]){candidates[candidate.relatedPort]=[]}candidates[candidate.relatedPort].push(candidate.port)}else if(!e.candidate){var relatedPorts=Object.keys(candidates);if(relatedPorts.length===1){var relatedPort=relatedPorts[0];var ports=candidates[relatedPort];_this2.resolve(ports.length===1?"nat.asymmetric":"nat.symmetric")}else if(relatedPorts.length===0){_this2.resolve("nat.noSrflx")}else{var hasAsymmetric=false;var hasSymmetric=false;for(var i=0;i<relatedPorts.length;i++){var _relatedPort=relatedPorts[i];var _ports=candidates[_relatedPort];if(_ports.length===1){hasAsymmetric=true}else{hasSymmetric=true}}if(hasSymmetric&&!hasAsymmetric){_this2.resolve("nat.symmetric")}else if(!hasSymmetric&&hasAsymmetric){_this2.resolve("nat.asymmetric")}else if(hasSymmetric&&hasAsymmetric){_this2.resolve("nat.both")}else{_this2.resolve("not.noSrflx")}}}};pc.onendofcandidates=pc.onicecandidate.bind(pc,{});pc.createOffer().then(function(offer){return pc.setLocalDescription(offer)});return this.promise}},{key:"destroy",value:function destroy(){_get(SymmetricNatTest.prototype.__proto__||Object.getPrototypeOf(SymmetricNatTest.prototype),"destroy",this).call(this)}}]);return SymmetricNatTest}(_Test3.default);exports.default=SymmetricNatTest},{"../utils/Test":32,"../utils/parseCandidate":36}],27:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};var _WebrtcCall=require("../utils/WebrtcCall");var _WebrtcCall2=_interopRequireDefault(_WebrtcCall);var _Test2=require("../utils/Test");var _Test3=_interopRequireDefault(_Test2);var _StatisticsAggregate=require("../utils/StatisticsAggregate");var _StatisticsAggregate2=_interopRequireDefault(_StatisticsAggregate);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var VideoBandwidthTest=function(_Test){_inherits(VideoBandwidthTest,_Test);function VideoBandwidthTest(){_classCallCheck(this,VideoBandwidthTest);var _this=_possibleConstructorReturn(this,(VideoBandwidthTest.__proto__||Object.getPrototypeOf(VideoBandwidthTest)).apply(this,arguments));_this.name="Video Bandwidth Test";_this.maxVideoBitrateKbps=2e3;_this.durationMs=4e4;_this.statStepMs=100;_this.bweStats=new _StatisticsAggregate2.default(.75*_this.maxVideoBitrateKbps*1e3);window.bweStats=_this.bweStats;_this.rttStats=new _StatisticsAggregate2.default;_this.packetsLost=null;_this.videoStats=[];_this.startTime=null;_this.call=null;_this.constraints={audio:false,video:{width:{min:640,ideal:1280,max:1920},height:{min:480,ideal:720,max:1080}}};if(_this.options.mediaOptions.video.deviceId){_this.constraints.video.deviceId=_this.options.mediaOptions.video.deviceId}_this.providedStream=_this.options.screenStream;_this.log=[];_this.stats={};return _this}_createClass(VideoBandwidthTest,[{key:"start",value:function start(){var _this2=this;_get(VideoBandwidthTest.prototype.__proto__||Object.getPrototypeOf(VideoBandwidthTest.prototype),"start",this).call(this);if(!this.options.iceConfig.iceServers.length){var error=new Error("No ice servers were provided");error.details=this.log;return this.reject(error)}this.call=new _WebrtcCall2.default(this.options.iceConfig,this.logger);this.call.setIceCandidateFilter(_WebrtcCall2.default.isRelay);this.call.disableVideoFec();this.call.constrainVideoBitrate(this.maxVideoBitrateKbps);var promise=void 0;if(this.providedStream){promise=this.gotStream(this.providedStream)}else{promise=this.doGetUserMedia(this.constraints)}return promise.then(function(){var results=_this2.getResults();if(!_this2.hasError){return _this2.resolve(results)}else{results.error=new Error("Video Bandwidth Error");return _this2.reject(results)}},function(err){var results=_this2.getResults();results.error=err;return _this2.reject(err)})}},{key:"getResults",value:function getResults(){return{log:this.log,stats:this.stats,constraints:this.constraints}}},{key:"addLog",value:function addLog(level,msg){this.logger[level.toLowerCase()](msg);if(msg&&(typeof msg==="undefined"?"undefined":_typeof(msg))==="object"){msg=JSON.stringify(msg)}if(level==="error"){this.hasError=true}this.log.push(level+": "+msg)}},{key:"doGetUserMedia",value:function doGetUserMedia(constraints){var _this3=this;this.addLog("info",{status:"pending",constraints:constraints});return navigator.mediaDevices.getUserMedia(constraints).then(function(stream){var camera=_this3.getDeviceName(stream.getVideoTracks());_this3.addLog("info",{status:"success",camera:camera});return _this3.gotStream(stream)},function(error){_this3.addLog("error",{status:"fail",error:error});_this3.addLog("error","Failed to get access to local media due to error: "+error.name);return _this3.reject(error)})}},{key:"getDeviceName",value:function getDeviceName(tracks){if(tracks.length===0){return null}return tracks[0].label}},{key:"gotStream",value:function gotStream(stream){var _this4=this;stream.getTracks().forEach(function(t){return _this4.call.pc1.pc.addTrack(t,stream)});return this.call.establishConnection().then(function(){_this4.addLog("info",{status:"success",message:"establishing connection"});_this4.startTime=new Date;_this4.localStream=stream.getVideoTracks()[0];return new Promise(function(resolve,reject){_this4.nextTimeout=setTimeout(function(){_this4.gatherStats().then(resolve,reject)},_this4.statStepMs)})},function(error){_this4.addLog("warn",{status:"error",error:error});return Promise.reject(error)})}},{key:"gatherStats",value:function gatherStats(){var _this5=this;var now=new Date;if(now-this.startTime>this.durationMs){return Promise.resolve(this.completed())}return this.call.pc1.getStats(null).then(this.gotStats.bind(this),function(error){_this5.addLog("error","Failed to getStats: "+error)})}},{key:"gotStats",value:function gotStats(response){var _this6=this;if(!response){this.addLog("error","Got no response from stats... odd...")}else{var results=typeof response.result==="function"?response.result():response;results.forEach(function(report){if(report.availableOutgoingBitrate){var value=parseInt(report.availableOutgoingBitrate,10);_this6.bweStats.add(new Date(report.timestamp),value)}if(report.totalRoundTripTime||report.roundTripTime){var _value=parseInt(report.totalRoundTripTime||report.roundTripTime,10);_this6.rttStats.add(new Date(report.timestamp),_value)}if(report.packetsSent){_this6.packetsSent=report.packetsSent}if(report.packetsLost){_this6.packetsLost=report.packetsLost}if(report.frameWidth){_this6.videoStats[0]=report.frameWidth}if(report.frameHeight){_this6.videoStats[1]=report.frameHeight}})}return new Promise(function(resolve,reject){_this6.nextTimeout=setTimeout(function(){_this6.gatherStats().then(resolve,reject)},_this6.statStepMs)})}},{key:"completed",value:function completed(){var isWebkit="WebkitAppearance"in document.documentElement.style;var isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;var pc=this.call.pc1;if(pc.getSenders){pc.getSenders().forEach(function(sender){return sender.track.stop()})}if(pc.getTransceivers){pc.getTransceivers().forEach(function(t){return t.stop()})}this.call.close();this.call=null;var stats=this.stats;if(isWebkit){if(this.videoStats[0]<2&&this.videoStats[1]<2){this.addLog("error","Camera failure: "+this.videoStats[0]+"x"+this.videoStats[1]+". Cannot test bandwidth without a working camera.")}else{stats.resolution=this.videoStats[0]+"x"+this.videoStats[1];stats.mbpsAvg=this.bweStats.getAverage()/(1e3*1e3);stats.mbpsMax=this.bweStats.getMax()/(1e3*1e3);stats.rampUpTimeMs=this.bweStats.getRampUpTime();this.addLog("info","Video resolution: "+stats.resolution);this.addLog("info","Send bandwidth estimate average: "+stats.mbpsAvg+" mpbs");this.addLog("info","Send bandwidth estimate max: "+stats.mbpsMax+" mbps");this.addLog("info","Send bandwidth ramp-up time: "+stats.rampUpTimeMs+" ms")}}else if(isFirefox){if(parseInt(this.framerateMean,10)>0){this.addLog("info","Frame rate mean: "+parseInt(this.framerateMean,10))}else{this.addLog("error","Frame rate mean is 0, cannot test bandwidth without a working camera.")}stats.framerateMean=this.framerateMean||null;stats.mbpsAvg=this.bitrateMean/(1e3*1e3);stats.mbpsStdDev=this.bitrateStdDev/(1e3*1e3);this.addLog("info","Send bitrate mean: "+stats.mbpsAvg+" mbps");this.addLog("info","Send bitrate standard deviation: "+stats.mbpsStdDev+" mbps")}stats.rttAverage=this.rttStats.getAverage();stats.rttMax=this.rttStats.getMax();if(this.packetsSent){stats.packetLoss=parseInt(this.packetsLost||0,10)/parseFloat(this.packetsSent)}this.addLog("info","RTT average: "+stats.rttAverage+" ms");this.addLog("info","RTT max: "+stats.rttMax+" ms");this.addLog("info","Lost packets: "+stats.lostPackets);return this.results}},{key:"destroy",value:function destroy(){_get(VideoBandwidthTest.prototype.__proto__||Object.getPrototypeOf(VideoBandwidthTest.prototype),"destroy",this).call(this);window.clearTimeout(this.nextTimeout);if(this.call){this.call.close();this.call=null}}}]);return VideoBandwidthTest}(_Test3.default);exports.default=VideoBandwidthTest},{"../utils/StatisticsAggregate":31,"../utils/Test":32,"../utils/WebrtcCall":35}],28:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};var _Test2=require("../utils/Test");var _Test3=_interopRequireDefault(_Test2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var LocalMedia=require("localmedia");var VideoTest=function(_Test){_inherits(VideoTest,_Test);function VideoTest(){_classCallCheck(this,VideoTest);var _this=_possibleConstructorReturn(this,(VideoTest.__proto__||Object.getPrototypeOf(VideoTest)).apply(this,arguments));_this.name="Video Test";_this.localMedia=new LocalMedia({detectSpeakingEvents:true});return _this}_createClass(VideoTest,[{key:"start",value:function start(){var _this2=this;_get(VideoTest.prototype.__proto__||Object.getPrototypeOf(VideoTest.prototype),"start",this).call(this);this.localMedia.start(this.options,function(err){if(err){_this2.logger.log("Video Local media start failed "+err.name);_this2.reject(err)}else{_this2.logger.log("Video Local media started")}});this.localMedia.on("localStream",function(stream){if(stream.getVideoTracks().length){var videoTrack=stream.getVideoTracks()[0];if(videoTrack){_this2.logger.log("Video stream passed");_this2.resolve()}else{_this2.logger.error("Video stream failed");_this2.reject(new Error("no video track available"))}}});return this.promise}},{key:"destroy",value:function destroy(){_get(VideoTest.prototype.__proto__||Object.getPrototypeOf(VideoTest.prototype),"destroy",this).call(this);this.localMedia.stop()}}]);return VideoTest}(_Test3.default);exports.default=VideoTest},{"../utils/Test":32,localmedia:4}],29:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _TestSuite=require("./utils/TestSuite");var _TestSuite2=_interopRequireDefault(_TestSuite);var _defaultTests=require("./defaultTests");var _VideoFrameChecker=require("./utils/VideoFrameChecker");var _VideoFrameChecker2=_interopRequireDefault(_VideoFrameChecker);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}exports.default={TestSuite:_TestSuite2.default,AudioTest:_defaultTests.AudioTest,VideoTest:_defaultTests.VideoTest,ConnectivityTest:_defaultTests.ConnectivityTest,AdvancedCameraTest:_defaultTests.AdvancedCameraTest,ThroughputTest:_defaultTests.ThroughputTest,VideoBandwidthTest:_defaultTests.VideoBandwidthTest,VideoFrameChecker:_VideoFrameChecker2.default,AudioBandwidthTest:_defaultTests.AudioBandwidthTest,SymmetricNatTest:_defaultTests.SymmetricNatTest}},{"./defaultTests":19,"./utils/TestSuite":33,"./utils/VideoFrameChecker":34}],30:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Ssim=function(){
function Ssim(){_classCallCheck(this,Ssim)}_createClass(Ssim,[{key:"statistics",value:function statistics(a){var accu=0;var i;for(i=0;i<a.length;++i){accu+=a[i]}var meanA=accu/(a.length-1);var diff=0;for(i=1;i<a.length;++i){diff=a[i-1]-meanA;accu+=a[i]+diff*diff}return{mean:meanA,variance:accu/a.length}}},{key:"covariance",value:function covariance(a,b,meanA,meanB){var accu=0;for(var i=0;i<a.length;i+=1){accu+=(a[i]-meanA)*(b[i]-meanB)}return accu/a.length}},{key:"calculate",value:function calculate(x,y){if(x.length!==y.length){return 0}var K1=.01;var K2=.03;var L=255;var C1=K1*L*(K1*L);var C2=K2*L*(K2*L);var C3=C2/2;var statsX=this.statistics(x);var muX=statsX.mean;var sigmaX2=statsX.variance;var sigmaX=Math.sqrt(sigmaX2);var statsY=this.statistics(y);var muY=statsY.mean;var sigmaY2=statsY.variance;var sigmaY=Math.sqrt(sigmaY2);var sigmaXy=this.covariance(x,y,muX,muY);var luminance=(2*muX*muY+C1)/(muX*muX+muY*muY+C1);var structure=(sigmaXy+C3)/(sigmaX*sigmaY+C3);var contrast=(2*sigmaX*sigmaY+C2)/(sigmaX2+sigmaY2+C2);return luminance*contrast*structure}}]);return Ssim}();exports.default=Ssim},{}],31:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var StatisticsAggregate=function(){function StatisticsAggregate(rampUpThreshold){_classCallCheck(this,StatisticsAggregate);this.startTime=0;this.sum=0;this.count=0;this.max=0;this.rampUpThreshold=rampUpThreshold;this.rampUpTime=Infinity}_createClass(StatisticsAggregate,[{key:"add",value:function add(time,datapoint){if(this.startTime===0){this.startTime=time}this.sum+=datapoint;this.max=Math.max(this.max,datapoint);if(this.rampUpTime===Infinity&&datapoint>this.rampUpThreshold){this.rampUpTime=time}this.count++}},{key:"getAverage",value:function getAverage(){if(this.count===0){return 0}return this.sum/this.count}},{key:"getMax",value:function getMax(){return this.max}},{key:"getRampUpTime",value:function getRampUpTime(){return this.rampUpTime-this.startTime}}]);return StatisticsAggregate}();exports.default=StatisticsAggregate},{}],32:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Test=function(){function Test(options){var _this=this;_classCallCheck(this,Test);this.options=options||{};this.logger=this.options.logger||console;this.promise=new Promise(function(resolve,reject){_this.deferred={resolve:resolve,reject:reject}})}_createClass(Test,[{key:"start",value:function start(){var _this2=this;this.timeout=window.setTimeout(function(){_this2.reject(new Error("Test Timeout"))},45e3)}},{key:"resolve",value:function resolve(data){this.deferred.resolve(data);return this.promise}},{key:"reject",value:function reject(err){this.deferred.reject(err);return this.promise}},{key:"destroy",value:function destroy(){window.clearTimeout(this.timeout)}}]);return Test}();exports.default=Test},{}],33:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var TestSuite=function(){function TestSuite(options){_classCallCheck(this,TestSuite);options=options||{};this.allTestsComplete=false;this.stopOnFailure=false;this.running=false;this.queue=[];this.logger=options.logger||console;this.hasError=false;this.results=[]}_createClass(TestSuite,[{key:"addTest",value:function addTest(test){this.queue.push(test)}},{key:"start",value:function start(){var _this=this;return new Promise(function(resolve,reject){return _this.runNextTest().then(function(){if(_this.hasError){var error=new Error("A test failure occurred");error.details=_this.results;return reject(error)}return resolve(_this.results)},function(err){err.details=_this.results;return reject(err)})})}},{key:"runNextTest",value:function runNextTest(){var _this2=this;this.running=true;var test=this.queue.shift();if(!test){this.running=false;return Promise.resolve()}this.activeTest=test;this.logger.log("Starting "+test.name);var next=function next(err){test.running=false;test.destroy();if(err){_this2.hasError=true;if(_this2.stopOnFailure){return Promise.reject(err)}}return _this2.runNextTest()};return test.start().then(function(results){_this2.results.push({status:"passed",name:test.name,results:results});return next()},function(err){_this2.hasError=true;var errInfo={status:"failed",name:test.name,message:err.message,details:err.details};_this2.results.push(errInfo);_this2.logger.error("Test failure",errInfo,test);return next(err)})}},{key:"stopAllTests",value:function stopAllTests(){this.activeTest.destroy();this.queue=[]}}]);return TestSuite}();exports.default=TestSuite},{}],34:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _Ssim=require("./Ssim.js");var _Ssim2=_interopRequireDefault(_Ssim);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var VideoFrameChecker=function(){function VideoFrameChecker(videoElement){_classCallCheck(this,VideoFrameChecker);this.frameStats={numFrozenFrames:0,numBlackFrames:0,numFrames:0};this.running=true;this.nonBlackPixelLumaThreshold=20;this.previousFrame=[];this.identicalFrameSsimThreshold=.985;this.frameComparator=new _Ssim2.default;this.canvas=document.createElement("canvas");this.videoElement=videoElement;this.listener=this.checkVideoFrame.bind(this);this.videoElement.addEventListener("play",this.listener,false)}_createClass(VideoFrameChecker,[{key:"stop",value:function stop(){this.videoElement.removeEventListener("play",this.listener);this.running=false}},{key:"getCurrentImageData",value:function getCurrentImageData(){this.canvas.width=this.videoElement.width;this.canvas.height=this.videoElement.height;var context=this.canvas.getContext("2d");context.drawImage(this.videoElement,0,0,this.canvas.width,this.canvas.height);return context.getImageData(0,0,this.canvas.width,this.canvas.height)}},{key:"checkVideoFrame",value:function checkVideoFrame(){if(!this.running){return}if(this.videoElement.ended){return}var imageData=this.getCurrentImageData();if(this.isBlackFrame(imageData.data,imageData.data.length)){this.frameStats.numBlackFrames++}if(this.frameComparator.calculate(this.previousFrame,imageData.data)>this.identicalFrameSsimThreshold){this.frameStats.numFrozenFrames++}this.previousFrame=imageData.data;this.frameStats.numFrames++;setTimeout(this.checkVideoFrame.bind(this),20)}},{key:"isBlackFrame",value:function isBlackFrame(data,length){var thresh=this.nonBlackPixelLumaThreshold;var accuLuma=0;for(var i=4;i<length;i+=4){accuLuma+=.21*data[i]+.72*data[i+1]+.07*data[i+2];if(accuLuma>thresh*i/4){return false}}return true}}]);return VideoFrameChecker}();exports.default=VideoFrameChecker},{"./Ssim.js":30}],35:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _webrtcStatsGatherer=require("webrtc-stats-gatherer");var _webrtcStatsGatherer2=_interopRequireDefault(_webrtcStatsGatherer);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var PeerConnection=require("rtcpeerconnection");var WebrtcCall=function(){function WebrtcCall(config,logger){var _this=this;_classCallCheck(this,WebrtcCall);this.pc1=new PeerConnection(config);this.pc2=new PeerConnection(config);this.logger=logger;this.pc1Gatherer=new _webrtcStatsGatherer2.default(this.pc1);this.pc1Gatherer.on("stats",function(stats){return _this.logger.log("pc1 webrtc stats",stats)});this.pc1Gatherer.collectInitialConnectionStats();this.pc1Gatherer.collectStats();this.pc2Gatherer=new _webrtcStatsGatherer2.default(this.pc2);this.pc2Gatherer.on("stats",function(stats){return _this.logger.log("pc2 webrtc stats",stats)});this.pc2Gatherer.collectInitialConnectionStats();this.pc2Gatherer.collectStats();this.pc1.on("ice",function(candidate){_this.logger.log("webrtc call pc1 candidate",candidate);_this.onIceCandidate(_this.pc2,candidate)});this.pc2.on("ice",function(candidate){_this.logger.log("webrtc call pc2 candidate",candidate);_this.onIceCandidate(_this.pc1,candidate)});this.iceCandidateFilter=WebrtcCall.noFilter}_createClass(WebrtcCall,[{key:"establishConnection",value:function establishConnection(){var _this2=this,_arguments=arguments;return this.pc1.pc.createOffer().then(this.gotOffer.bind(this),function(){var _logger;return(_logger=_this2.logger).error.apply(_logger,_arguments)})}},{key:"close",value:function close(){this.pc1.close();this.pc2.close()}},{key:"gatherStats",value:function gatherStats(peerConnection,interval){var stats=[];var statsCollectTime=[];return new Promise(function(resolve,reject){var getStats=function getStats(){window.pc=peerConnection;if(peerConnection.signalingState==="closed"){return resolve({stats:stats,statsCollectTime:statsCollectTime})}setTimeout(function(){var getStatsTimeout=setTimeout(function(){resolve({stats:stats,statsCollectTime:statsCollectTime})},1e3);peerConnection.getStats(null).then(function(response){clearTimeout(getStatsTimeout);getStatsTimeout=null;gotStats(response)})},interval)};var gotStats=function gotStats(response){if(!response){return getStats()}var now=Date.now();var results=response.result?response.result():response;stats=results;statsCollectTime=Object.keys(results).map(function(){return now});getStats()};getStats()})}},{key:"gotOffer",value:function gotOffer(offer){this.pc1.pc.setLocalDescription(offer);this.pc2.pc.setRemoteDescription(offer);return this.pc2.pc.createAnswer().then(this.gotAnswer.bind(this),console.error.bind(console))}},{key:"gotAnswer",value:function gotAnswer(answer){if(this.constrainVideoBitrateKbps){answer.sdp=answer.sdp.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+this.constrainVideoBitrateKbps+"\r\n")}this.pc2.pc.setLocalDescription(answer);return this.pc1.pc.setRemoteDescription(answer)}},{key:"onIceCandidate",value:function onIceCandidate(otherPeer,event){if(event.candidate){var parsed=this.parseCandidate(event.candidate.candidate);if(this.iceCandidateFilter(parsed)){otherPeer.pc.addIceCandidate(event.candidate)}}}},{key:"parseCandidate",value:function parseCandidate(text){var candidateStr="candidate:";var pos=text.indexOf(candidateStr)+candidateStr.length;var fields=text.substr(pos).split(" ");return{type:fields[7],protocol:fields[2],address:fields[4]}}},{key:"setIceCandidateFilter",value:function setIceCandidateFilter(filter){this.iceCandidateFilter=filter}},{key:"disableVideoFec",value:function disableVideoFec(){this.constrainOfferToRemoveVideoFec=true}},{key:"constrainVideoBitrate",value:function constrainVideoBitrate(maxVideoBitrateKbps){this.constrainVideoBitrateKbps=maxVideoBitrateKbps}}],[{key:"noFilter",value:function noFilter(){return true}},{key:"isRelay",value:function isRelay(candidate){return candidate.type==="relay"}}]);return WebrtcCall}();exports.default=WebrtcCall},{rtcpeerconnection:8,"webrtc-stats-gatherer":17}],36:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});function parseCandidate(line){var parts;if(line.indexOf("a=candidate:")===0){parts=line.substring(12).split(" ")}else{parts=line.substring(10).split(" ")}var candidate={foundation:parts[0],component:parts[1],protocol:parts[2].toLowerCase(),priority:parseInt(parts[3],10),ip:parts[4],port:parseInt(parts[5],10),type:parts[7]};for(var i=8;i<parts.length;i+=2){switch(parts[i]){case"raddr":candidate.relatedAddress=parts[i+1];break;case"rport":candidate.relatedPort=parseInt(parts[i+1],10);break;case"tcptype":candidate.tcpType=parts[i+1];break;default:break}}return candidate}exports.default=parseCandidate},{}]},{},[29])(29)});